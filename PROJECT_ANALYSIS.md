# Oatodify é¡¹ç›®åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2025-10-17  
**åˆ†æç‰ˆæœ¬**: v1.0.0  
**ä»£ç åº“**: OAæ–‡æ¡£å¤„ç†ç³»ç»Ÿ (Oatodify)

---

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. é¡¹ç›®ç»“æ„åˆ†æ](#2-é¡¹ç›®ç»“æ„åˆ†æ)
- [3. æŠ€æœ¯æ ˆä¸ä¾èµ–](#3-æŠ€æœ¯æ ˆä¸ä¾èµ–)
- [4. æ ¸å¿ƒåŠŸèƒ½åˆ†æ](#4-æ ¸å¿ƒåŠŸèƒ½åˆ†æ)
- [5. ç³»ç»Ÿæ¶æ„](#5-ç³»ç»Ÿæ¶æ„)
- [6. æ•°æ®æ¨¡å‹](#6-æ•°æ®æ¨¡å‹)
- [7. API ç«¯ç‚¹](#7-api-ç«¯ç‚¹)
- [8. ä¸šåŠ¡æµç¨‹](#8-ä¸šåŠ¡æµç¨‹)
- [9. ä»£ç è´¨é‡è¯„ä¼°](#9-ä»£ç è´¨é‡è¯„ä¼°)
- [10. æ–‡æ¡£ç°çŠ¶](#10-æ–‡æ¡£ç°çŠ¶)
- [11. æ”¹è¿›å»ºè®®](#11-æ”¹è¿›å»ºè®®)
- [12. æŠ€æœ¯å€ºåŠ¡](#12-æŠ€æœ¯å€ºåŠ¡)
- [13. éƒ¨ç½²æ–¹æ¡ˆ](#13-éƒ¨ç½²æ–¹æ¡ˆ)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**Oatodify** æ˜¯ä¸€ä¸ªæ™ºèƒ½åŒ–çš„ OA æ–‡æ¡£å¤„ç†ä¸çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸ºä¼ä¸šåŠå…¬è‡ªåŠ¨åŒ–åœºæ™¯è®¾è®¡ã€‚ç³»ç»Ÿå®ç°äº†ä»æ–‡æ¡£è·å–ã€è§£å¯†ã€åˆ†æåˆ°çŸ¥è¯†åº“é›†æˆçš„å…¨ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–ç®¡ç†ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **è‡ªåŠ¨åŒ–å¤„ç†**: ä» S3 å­˜å‚¨è‡ªåŠ¨ä¸‹è½½ã€è§£å¯†ã€è§£ææ–‡æ¡£
- **æ™ºèƒ½åˆ†æ**: ä½¿ç”¨ AI è¯„ä¼°æ–‡æ¡£ä»·å€¼å’Œé€‚ç”¨æ€§
- **çŸ¥è¯†åº“é›†æˆ**: è‡ªåŠ¨å°†æœ‰ä»·å€¼æ–‡æ¡£åŒæ­¥åˆ° Dify çŸ¥è¯†åº“
- **å¤šçŸ¥è¯†åº“æ”¯æŒ**: æ”¯æŒå¤šä¸ªçŸ¥è¯†åº“å’Œä¸šåŠ¡åˆ†ç±»è·¯ç”±
- **äººå·¥å®¡æ ¸**: æä¾› Web ç•Œé¢è¿›è¡Œäººå·¥å¹²é¢„å’Œå®¡æ‰¹
- **å®æ—¶ç›‘æ§**: å®Œæ•´çš„å¤„ç†çŠ¶æ€è¿½è¸ªå’Œç»Ÿè®¡åˆ†æ

### 1.3 ä»£ç ç»Ÿè®¡

```
æ€»è®¡ Python æ–‡ä»¶: 22 ä¸ª
æ€»ä»£ç è¡Œæ•°: çº¦ 5,852 è¡Œ
ä¸»è¦æ¨¡å—: 8 ä¸ªæœåŠ¡æ¨¡å— + 3 ä¸ªé¡µé¢æ¨¡æ¿ + 1 ä¸ªä»»åŠ¡å¤„ç†å™¨
```

---

## 2. é¡¹ç›®ç»“æ„åˆ†æ

### 2.1 ç›®å½•ç»“æ„

```
oatodify/
â”œâ”€â”€ api/                          # REST API å±‚
â”‚   â””â”€â”€ routes.py                 # API è·¯ç”±å®šä¹‰ (621 è¡Œ)
â”œâ”€â”€ services/                     # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ ai_analyzer.py           # AI æ–‡æ¡£åˆ†ææœåŠ¡ (595 è¡Œ)
â”‚   â”œâ”€â”€ api_document_parser.py   # æ–‡æ¡£è§£ææœåŠ¡ (237 è¡Œ)
â”‚   â”œâ”€â”€ decryption_service.py    # æ–‡æ¡£è§£å¯†æœåŠ¡ (208 è¡Œ)
â”‚   â”œâ”€â”€ dify_service.py          # Dify çŸ¥è¯†åº“é›†æˆ (627 è¡Œ)
â”‚   â”œâ”€â”€ file_filter.py           # æ–‡ä»¶ç­›é€‰æœåŠ¡ (488 è¡Œ)
â”‚   â”œâ”€â”€ s3_service.py            # S3 å­˜å‚¨æœåŠ¡ (128 è¡Œ)
â”‚   â””â”€â”€ system_monitor.py        # ç³»ç»Ÿç›‘æ§æœåŠ¡ (401 è¡Œ)
â”œâ”€â”€ tasks/                        # å¼‚æ­¥ä»»åŠ¡å±‚
â”‚   â””â”€â”€ document_processor.py    # æ–‡æ¡£å¤„ç†ä»»åŠ¡ (590 è¡Œ)
â”œâ”€â”€ templates/                    # Web UI æ¨¡æ¿
â”‚   â”œâ”€â”€ dashboard.py             # ä»ªè¡¨æ¿é¡µé¢ (333 è¡Œ)
â”‚   â”œâ”€â”€ approval.py              # å®¡æ ¸é¡µé¢ (324 è¡Œ)
â”‚   â””â”€â”€ settings.py              # è®¾ç½®é¡µé¢ (603 è¡Œ)
â”œâ”€â”€ utils/                        # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ api_config.py            # API é…ç½®å·¥å…·
â”‚   â””â”€â”€ file_utils.py            # æ–‡ä»¶å¤„ç†å·¥å…·
â”œâ”€â”€ config.py                     # é…ç½®ç®¡ç† (77 è¡Œ)
â”œâ”€â”€ models.py                     # æ•°æ®æ¨¡å‹ (170 è¡Œ)
â”œâ”€â”€ database.py                   # æ•°æ®åº“è¿æ¥ (33 è¡Œ)
â”œâ”€â”€ main.py                       # FastAPI åº”ç”¨å…¥å£ (50 è¡Œ)
â”œâ”€â”€ app.py                        # Streamlit åº”ç”¨å…¥å£ (39 è¡Œ)
â”œâ”€â”€ celery_app.py                # Celery é…ç½® (8 è¡Œ)
â”œâ”€â”€ docker-compose.yml           # Docker ç¼–æ’é…ç½®
â”œâ”€â”€ Dockerfile                    # å®¹å™¨é•œåƒå®šä¹‰
â”œâ”€â”€ init-db.sql                  # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜æ–‡æ¡£ (479 è¡Œ)
â””â”€â”€ AI_CONFIG.md                 # AI é…ç½®æ–‡æ¡£ (235 è¡Œ)
```

### 2.2 æ¨¡å—èŒè´£

#### 2.2.1 API å±‚ (`api/`)
- **routes.py**: å®šä¹‰æ‰€æœ‰ REST API ç«¯ç‚¹
- æä¾›æ–‡ä»¶ç®¡ç†ã€å¤„ç†ä»»åŠ¡ã€å®¡æ‰¹æµç¨‹ã€ç³»ç»Ÿç›‘æ§ç­‰æ¥å£
- æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€å¯¼å‡ºç­‰é«˜çº§åŠŸèƒ½

#### 2.2.2 æœåŠ¡å±‚ (`services/`)
- **ai_analyzer.py**: æ ¸å¿ƒ AI åˆ†æé€»è¾‘ï¼Œæ”¯æŒå¤šåˆ†ç±»å¤„ç†å™¨
- **dify_service.py**: Dify çŸ¥è¯†åº“ API å°è£…ï¼Œæ”¯æŒå¤šçŸ¥è¯†åº“ç®¡ç†
- **s3_service.py**: S3 å…¼å®¹å­˜å‚¨è®¿é—®
- **decryption_service.py**: AES/ZIP è§£å¯†å¤„ç†
- **api_document_parser.py**: è°ƒç”¨å¤–éƒ¨è§£ææœåŠ¡æå–æ–‡æ¡£å†…å®¹
- **file_filter.py**: æ–‡ä»¶ç­›é€‰å’Œé‡å¤æ£€æµ‹
- **system_monitor.py**: ç³»ç»Ÿå¥åº·æ£€æŸ¥å’Œç›‘æ§

#### 2.2.3 ä»»åŠ¡å±‚ (`tasks/`)
- **document_processor.py**: Celery å¼‚æ­¥ä»»åŠ¡å®šä¹‰
- å®ç°å®Œæ•´çš„æ–‡æ¡£å¤„ç†æµç¨‹ç¼–æ’
- æ”¯æŒå•æ–‡æ¡£å’Œæ‰¹é‡å¤„ç†

#### 2.2.4 æ¨¡æ¿å±‚ (`templates/`)
- **dashboard.py**: æ•°æ®ç»Ÿè®¡å’Œå¯è§†åŒ–
- **approval.py**: äººå·¥å®¡æ ¸ç•Œé¢
- **settings.py**: ç³»ç»Ÿé…ç½®ç®¡ç†ç•Œé¢

---

## 3. æŠ€æœ¯æ ˆä¸ä¾èµ–

### 3.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|---------|---------|------|
| **Python** | â‰¥ 3.11 | ä¸»è¦ç¼–ç¨‹è¯­è¨€ |
| **FastAPI** | â‰¥ 0.116.1 | REST API æ¡†æ¶ |
| **Streamlit** | â‰¥ 1.49.1 | Web UI æ¡†æ¶ |
| **Celery** | â‰¥ 5.5.3 | å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— |
| **SQLAlchemy** | â‰¥ 2.0.43 | ORM æ¡†æ¶ |
| **PostgreSQL** | â‰¥ 12.0 | å…³ç³»å‹æ•°æ®åº“ |
| **Redis** | â‰¥ 6.0 | æ¶ˆæ¯é˜Ÿåˆ—ä¸ç¼“å­˜ |
| **boto3** | â‰¥ 1.40.31 | AWS S3 SDK |
| **OpenAI** | â‰¥ 1.107.3 | AI åˆ†æ SDK |

### 3.2 å®Œæ•´ä¾èµ–æ¸…å•

```toml
[project.dependencies]
boto3 = ">=1.40.31"                # S3 å­˜å‚¨è®¿é—®
celery = ">=5.5.3"                 # å¼‚æ­¥ä»»åŠ¡å¤„ç†
fastapi = ">=0.116.1"              # API æ¡†æ¶
openai = ">=1.107.3"               # AI é›†æˆ
pandas = ">=2.3.2"                 # æ•°æ®å¤„ç†
plotly = ">=6.3.0"                 # æ•°æ®å¯è§†åŒ–
psycopg2-binary = ">=2.9.10"       # PostgreSQL é©±åŠ¨
pycryptodome = ">=3.23.0"          # åŠ å¯†/è§£å¯†
pydantic = ">=2.11.9"              # æ•°æ®éªŒè¯
pydantic-settings = ">=2.10.1"     # é…ç½®ç®¡ç†
redis = ">=6.4.0"                  # Redis å®¢æˆ·ç«¯
requests = ">=2.32.5"              # HTTP è¯·æ±‚
sqlalchemy = ">=2.0.43"            # ORM
streamlit = ">=1.49.1"             # Web UI
uvicorn = ">=0.35.0"               # ASGI æœåŠ¡å™¨
```

### 3.3 å¤–éƒ¨æœåŠ¡ä¾èµ–

1. **PostgreSQL æ•°æ®åº“**: å­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®ã€å¤„ç†æ—¥å¿—ã€çŸ¥è¯†åº“é…ç½®
2. **Redis**: Celery æ¶ˆæ¯é˜Ÿåˆ—å’Œç»“æœåç«¯
3. **S3 å…¼å®¹å­˜å‚¨**: æºæ–‡æ¡£å­˜å‚¨ï¼ˆæ”¯æŒ AWS S3ã€MinIO ç­‰ï¼‰
4. **OpenAI API**: AI æ–‡æ¡£åˆ†æï¼ˆæ”¯æŒå®˜æ–¹ API å’Œå…¼å®¹æœåŠ¡ï¼‰
5. **Dify å¹³å°**: çŸ¥è¯†åº“ç®¡ç†å’Œæ£€ç´¢
6. **æ–‡æ¡£è§£ææœåŠ¡**: å¤–éƒ¨æ–‡æ¡£è§£æ APIï¼ˆPDFã€DOCX ç­‰ï¼‰

---

## 4. æ ¸å¿ƒåŠŸèƒ½åˆ†æ

### 4.1 åŠŸèƒ½æ¨¡å—æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OA æ–‡æ¡£å¤„ç†ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  æ–‡æ¡£ä¸‹è½½    â”‚  â”‚  æ–‡æ¡£è§£å¯†    â”‚  â”‚  å†…å®¹è§£æ    â”‚     â”‚
â”‚  â”‚  (S3 Pull)   â”‚  â”‚  (AES/ZIP)   â”‚  â”‚  (API)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â†“                â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  AI åˆ†æ     â”‚  â”‚  äººå·¥å®¡æ ¸    â”‚  â”‚  çŸ¥è¯†åº“åŒæ­¥  â”‚     â”‚
â”‚  â”‚  (OpenAI)    â”‚  â”‚  (Approval)  â”‚  â”‚  (Dify)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â†“                â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚          å®æ—¶ç›‘æ§ä¸ç»Ÿè®¡åˆ†æ (Dashboard)           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 åŠŸèƒ½è¯¦ç»†è¯´æ˜

#### 4.2.1 æ–‡æ¡£ä¸‹è½½ä¸è§£å¯†

**åŠŸèƒ½æè¿°**:
- ä» S3 å…¼å®¹å­˜å‚¨è‡ªåŠ¨ä¸‹è½½æ–‡æ¡£
- æ”¯æŒ AES åŠ å¯†æ–‡æ¡£çš„è‡ªåŠ¨è§£å¯†
- æ”¯æŒ ZIP å‹ç¼©åŒ…çš„è§£å‹
- è‡ªåŠ¨å¤„ç†å¯†ç ä¿æŠ¤çš„æ–‡æ¡£

**å®ç°ä½ç½®**:
- `services/s3_service.py`: S3 ä¸‹è½½
- `services/decryption_service.py`: è§£å¯†é€»è¾‘

**æ”¯æŒæ ¼å¼**:
- AES åŠ å¯†æ–‡ä»¶ (ä½¿ç”¨ asecode å‚æ•°)
- ZIP å‹ç¼©åŒ… (è‡ªåŠ¨è§£å‹)
- å¯†ç ä¿æŠ¤æ–‡æ¡£ (æ”¯æŒå¸¸è§å¯†ç åˆ—è¡¨)

#### 4.2.2 æ–‡æ¡£å†…å®¹è§£æ

**åŠŸèƒ½æè¿°**:
- è°ƒç”¨å¤–éƒ¨ API è§£ææ–‡æ¡£å†…å®¹
- æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼
- åˆ†å—å¤„ç†å¤§å‹æ–‡æ¡£
- æå–å…ƒæ•°æ®å’Œç»“æ„åŒ–ä¿¡æ¯

**å®ç°ä½ç½®**:
- `services/api_document_parser.py`

**æ”¯æŒæ ¼å¼**:
- PDF (å«æ‰«æä»¶å’Œçº¯æ–‡æœ¬)
- DOCX, DOC
- TXT
- å…¶ä»–é€šè¿‡ API æ”¯æŒçš„æ ¼å¼

**è§£æç»“æœ**:
```json
{
  "content": "æ–‡æ¡£æ–‡æœ¬å†…å®¹",
  "chunks_count": 5,
  "parsing_method": "api_interface",
  "file_type": "pdf",
  "success": true
}
```

#### 4.2.3 AI æ™ºèƒ½åˆ†æ

**åŠŸèƒ½æè¿°**:
- ä½¿ç”¨ OpenAI æ¨¡å‹åˆ†ææ–‡æ¡£ä»·å€¼
- æ”¯æŒå¤šä¸šåŠ¡åˆ†ç±»çš„å®šåˆ¶åŒ–åˆ†æ
- ç”Ÿæˆç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Š
- è®¡ç®—ç½®ä¿¡åº¦è¯„åˆ†

**å®ç°ä½ç½®**:
- `services/ai_analyzer.py`

**ä¸šåŠ¡åˆ†ç±»** (8 ç§):
1. **æ€»è¡Œå‘æ–‡** (HEADQUARTERS_ISSUE)
2. **é›¶å”®æ¡çº¿å…¬å‘Š** (RETAIL_ANNOUNCEMENT)
3. **åˆŠç‰©å‘å¸ƒ** (PUBLICATION_RELEASE)
4. **æ”¯è¡Œå‘æ–‡** (BRANCH_ISSUE)
5. **æ”¯è¡Œæ”¶æ–‡** (BRANCH_RECEIVE)
6. **å…¬å…±å‘å¸ƒåŠè§„èŒƒæ–‡ä»¶** (PUBLIC_STANDARD)
7. **æ€»è¡Œæ”¶æ–‡** (HEADQUARTERS_RECEIVE)
8. **å…¬å¸æ¡çº¿å…¬å‘Š** (CORPORATE_ANNOUNCEMENT)

**AI åˆ†æè¾“å‡º**:
```json
{
  "suitable_for_kb": true,
  "confidence_score": 85,
  "reasons": ["åŒ…å«å®ç”¨æ“ä½œæŒ‡å¯¼", "å†…å®¹å®Œæ•´å‡†ç¡®"],
  "summary": "æ–‡æ¡£æ‘˜è¦...",
  "category_specific_fields": {
    "policy_level": "strategic",
    "implementation_difficulty": "medium"
  }
}
```

**åˆ†ç±»ç‰¹å®šå­—æ®µ**:
- æ€»è¡Œå‘æ–‡: `policy_level`, `target_audience`, `implementation_difficulty`
- é›¶å”®å…¬å‘Š: `service_impact`, `product_relevance`, `training_value`
- åˆŠç‰©å‘å¸ƒ: `information_type`, `reference_value`, `knowledge_depth`
- ... (æ¯ç§åˆ†ç±»éƒ½æœ‰ä¸“å±å­—æ®µ)

#### 4.2.4 å¤šçŸ¥è¯†åº“ç®¡ç†

**åŠŸèƒ½æè¿°**:
- æ”¯æŒå¤šä¸ªç‹¬ç«‹çš„çŸ¥è¯†åº“
- åŸºäºä¸šåŠ¡åˆ†ç±»çš„çŸ¥è¯†åº“è·¯ç”±
- æ¯ä¸ªåˆ†ç±»å¯é…ç½®ä¸“å±çš„ AI æç¤ºè¯
- çµæ´»çš„è´¨é‡æ§åˆ¶é˜ˆå€¼

**å®ç°ä½ç½®**:
- `services/dify_service.py`: Dify API å°è£…
- `models.py`: çŸ¥è¯†åº“å’Œæ˜ å°„è¡¨æ¨¡å‹

**æ•°æ®åº“è¡¨è®¾è®¡**:

```sql
-- çŸ¥è¯†åº“ä¿¡æ¯è¡¨
knowledge_bases (
  id, name, description, dify_dataset_id,
  api_key, base_url, status, document_count
)

-- åˆ†ç±»æ˜ å°„è¡¨
document_category_mappings (
  knowledge_base_id, business_category,
  ai_prompt_template, ai_output_schema,
  min_confidence_score, auto_approve_threshold
)
```

**é…ç½®ç¤ºä¾‹**:
- é›¶å”®ä¸šåŠ¡æ–‡æ¡£ â†’ é›¶å”®çŸ¥è¯†åº“ (ä½¿ç”¨ä¸“é—¨æç¤ºè¯)
- é£é™©ç®¡ç†æ–‡æ¡£ â†’ é£é™©çŸ¥è¯†åº“ (é«˜ç½®ä¿¡åº¦è¦æ±‚)
- é€šç”¨æ–‡æ¡£ â†’ é»˜è®¤çŸ¥è¯†åº“

#### 4.2.5 äººå·¥å®¡æ ¸æµç¨‹

**åŠŸèƒ½æè¿°**:
- Web ç•Œé¢å®¡æ ¸å¾…å¤„ç†æ–‡æ¡£
- æŸ¥çœ‹ AI åˆ†æç»“æœ
- æ‰‹åŠ¨æ‰¹å‡†æˆ–æ‹’ç»
- æ‰¹é‡å®¡æ ¸æ“ä½œ

**å®ç°ä½ç½®**:
- `templates/approval.py`: å®¡æ ¸ç•Œé¢
- `api/routes.py`: å®¡æ‰¹ API

**å®¡æ ¸æµç¨‹**:
```
AWAITING_APPROVAL â†’ (äººå·¥å®¡æ ¸) â†’ APPROVED/REJECTED
                                      â†“
                              è‡ªåŠ¨æ·»åŠ åˆ°çŸ¥è¯†åº“
```

**è‡ªåŠ¨å®¡æ‰¹**:
- ç½®ä¿¡åº¦ â‰¥ auto_approve_threshold: è‡ªåŠ¨æ‰¹å‡†
- ç½®ä¿¡åº¦ < auto_approve_threshold: éœ€äººå·¥å®¡æ ¸

#### 4.2.6 æ–‡ä»¶ç­›é€‰ä¸å»é‡

**åŠŸèƒ½æè¿°**:
- åŸºäºå…³é”®å­—çš„æ–‡ä»¶ç­›é€‰
- é‡å¤æ–‡ä»¶æ£€æµ‹
- æ–‡ä»¶å¤§å°é™åˆ¶
- ä¸šåŠ¡åˆ†ç±»ç‰¹å®šçš„ç­›é€‰è§„åˆ™

**å®ç°ä½ç½®**:
- `services/file_filter.py`

**ç­›é€‰å™¨ç±»å‹**:
1. **åŸºç¡€éªŒè¯**: æ–‡ä»¶åã€å¤§å°ã€å¿…å¡«å­—æ®µ
2. **å…³é”®å­—ç­›é€‰**: å…±ç”¨å…³é”®å­— + åˆ†ç±»ç‰¹å®šå…³é”®å­—
3. **é‡å¤æ£€æµ‹**: åŸºäºæ–‡ä»¶åå’Œå¤§å°çš„é‡å¤æ£€æŸ¥
4. **æ–‡ä»¶ç±»å‹**: æ”¯æŒçš„æ ¼å¼éªŒè¯

**é…ç½®ç¤ºä¾‹**:
```env
# å…±ç”¨å…³é”®å­—ï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ£€æŸ¥ï¼‰
FILTER_KEYWORDS_COMMON="test,demo,temp,draft,backup"

# é›¶å”®æ¡çº¿ç‰¹å®šå…³é”®å­—
FILTER_KEYWORDS_RETAIL_ANNOUNCEMENT="internal_only,obsolete"

# ç­›é€‰å¼€å…³
FILTER_ENABLE_KEYWORD_FILTER=true
FILTER_ENABLE_DUPLICATE_FILTER=true
```

#### 4.2.7 ç³»ç»Ÿç›‘æ§ä¸è¯Šæ–­

**åŠŸèƒ½æè¿°**:
- å®æ—¶ç³»ç»Ÿå¥åº·æ£€æŸ¥
- æ•°æ®åº“è¿æ¥ç›‘æ§
- S3 å­˜å‚¨çŠ¶æ€æ£€æµ‹
- Redis é˜Ÿåˆ—ç›‘æ§
- å¤„ç†ä»»åŠ¡ç»Ÿè®¡
- é”™è¯¯æ—¥å¿—æ”¶é›†

**å®ç°ä½ç½®**:
- `services/system_monitor.py`
- `templates/dashboard.py`: å¯è§†åŒ–å±•ç¤º

**ç›‘æ§æŒ‡æ ‡**:
- æ–‡æ¡£å¤„ç†ç»Ÿè®¡ (æ€»æ•°ã€æˆåŠŸç‡ã€å¤±è´¥æ•°)
- é˜Ÿåˆ—çŠ¶æ€ (å¾…å¤„ç†ã€å¤„ç†ä¸­)
- ç³»ç»Ÿèµ„æº (æ•°æ®åº“ã€Redisã€S3)
- å¤„ç†æ€§èƒ½ (å¹³å‡è€—æ—¶ã€ååé‡)
- é”™è¯¯åˆ†æ (é”™è¯¯ç±»å‹ã€é¢‘ç‡)

---

## 5. ç³»ç»Ÿæ¶æ„

### 5.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Streamlit UI    â”‚              â”‚   REST API       â”‚        â”‚
â”‚  â”‚  (Web Interface) â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (FastAPI)      â”‚        â”‚
â”‚  â”‚  Port: 8501      â”‚              â”‚   Port: 8000     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                              â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸šåŠ¡å±‚                 â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚              Celery Worker Pool                    â”‚         â”‚
â”‚  â”‚  (Async Document Processing Tasks)                â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                        â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚              â”‚               â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ S3 Service â”‚ â”‚ AI Analyzerâ”‚ â”‚Dify Serviceâ”‚                â”‚
â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚   Redis     â”‚  â”‚  S3 Storage  â”‚           â”‚
â”‚  â”‚ (Metadata)  â”‚  â”‚  (Queue)    â”‚  â”‚  (Files)     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœåŠ¡å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  OpenAI API    â”‚   â”‚ Document Parserâ”‚   â”‚  Dify Platform â”‚ â”‚
â”‚  â”‚  (AI Analysis) â”‚   â”‚   (Parsing)    â”‚   â”‚  (Knowledge)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ¶æ„æ¨¡å¼

#### 5.2.1 åˆ†å±‚æ¶æ„

1. **è¡¨ç°å±‚** (Presentation Layer)
   - Streamlit Web UI
   - FastAPI REST API
   - è´Ÿè´£ç”¨æˆ·äº¤äº’å’Œè¯·æ±‚è·¯ç”±

2. **ä¸šåŠ¡å±‚** (Business Layer)
   - Services: ä¸šåŠ¡é€»è¾‘å°è£…
   - Tasks: å¼‚æ­¥ä»»åŠ¡ç¼–æ’
   - è´Ÿè´£æ ¸å¿ƒä¸šåŠ¡å¤„ç†

3. **æ•°æ®å±‚** (Data Layer)
   - SQLAlchemy ORM
   - PostgreSQL æ•°æ®åº“
   - è´Ÿè´£æ•°æ®æŒä¹…åŒ–

4. **é›†æˆå±‚** (Integration Layer)
   - S3 Service
   - OpenAI API
   - Dify API
   - è´Ÿè´£å¤–éƒ¨æœåŠ¡é›†æˆ

#### 5.2.2 å¼‚æ­¥å¤„ç†æ¨¡å¼

```python
# å…¸å‹çš„å¼‚æ­¥ä»»åŠ¡æµç¨‹
@app.task
def process_document(file_id: str):
    # 1. ä¸‹è½½ (S3)
    file_data = s3_service.download_file(token)
    
    # 2. è§£å¯† (Decryption)
    decrypted = decryption_service.decrypt(file_data)
    
    # 3. è§£æ (API)
    content = api_parser.parse_document(decrypted)
    
    # 4. AI åˆ†æ (OpenAI)
    analysis = ai_analyzer.analyze(content)
    
    # 5. çŸ¥è¯†åº“åŒæ­¥ (Dify)
    if analysis.suitable_for_kb:
        dify_service.add_document(content)
```

**ä¼˜åŠ¿**:
- éé˜»å¡ I/O
- é«˜å¹¶å‘å¤„ç†
- å¤±è´¥é‡è¯•æœºåˆ¶
- ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†

#### 5.2.3 æœåŠ¡åŒ–è®¾è®¡

æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ç±»ï¼Œå…·æœ‰æ¸…æ™°çš„èŒè´£è¾¹ç•Œ:

```python
# æœåŠ¡å®ä¾‹åŒ–ç¤ºä¾‹
s3_service = S3Service()
ai_analyzer = AIAnalyzer()
dify_service = DifyService()
```

**ç‰¹ç‚¹**:
- å•ä¸€èŒè´£åŸåˆ™
- ä¾èµ–æ³¨å…¥
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒæœåŠ¡æ›¿æ¢

### 5.3 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ S3 File  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Download    â”‚ (S3 Service)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Decrypt     â”‚ (Decryption Service)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parse       â”‚ (API Document Parser)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Analyze  â”‚ (AI Analyzer)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Approval?   â”‚ (Manual or Auto)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upload KB   â”‚ (Dify Service)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Complete    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ•°æ®æ¨¡å‹

### 6.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 6.1.1 OAFileInfo (ä¸»è¡¨)

**ç”¨é€”**: å­˜å‚¨ OA ç³»ç»Ÿæ–‡ä»¶çš„å…ƒæ•°æ®å’Œå¤„ç†çŠ¶æ€

```python
class OAFileInfo(Base):
    __tablename__ = "oa_file_info"
    
    # ä¸»é”®
    id: Integer (ä¸»é”®)
    
    # åŸºç¡€ä¿¡æ¯
    imagefileid: String(100) (å”¯ä¸€, ç´¢å¼•)  # æ–‡ä»¶ID
    business_category: Enum(BusinessCategory)  # ä¸šåŠ¡åˆ†ç±»
    is_zw: Boolean  # æ˜¯å¦æ­£æ–‡
    fj_imagefileid: Text  # é™„ä»¶IDåˆ—è¡¨(JSON)
    imagefilename: String(500)  # æ–‡ä»¶å
    imagefiletype: String(50)  # æ–‡æ¡£ç±»å‹
    is_zip: Boolean  # æ˜¯å¦å‹ç¼©æ–‡ä»¶
    filesize: Integer  # æ–‡ä»¶å¤§å°(å­—èŠ‚)
    asecode: String(255)  # è§£å¯†code
    tokenkey: String(500)  # OSSä¸‹è½½key
    
    # å¤„ç†çŠ¶æ€
    processing_status: Enum(ProcessingStatus)
    processing_message: Text
    processing_started_at: DateTime
    processing_completed_at: DateTime
    
    # AIåˆ†æç»“æœ
    ai_analysis_result: Text (JSON)
    ai_confidence_score: Integer (0-100)
    should_add_to_kb: Boolean
    
    # å…³è”ä¿¡æ¯
    document_id: String(100)  # Difyæ–‡æ¡£ID
    target_knowledge_base_id: Integer (å¤–é”®)
    
    # åŒæ­¥ä¿¡æ¯
    sync_source: String(50)
    last_sync_at: DateTime
    
    # é”™è¯¯ä¿¡æ¯
    error_count: Integer
    last_error: Text
    
    # æ—¶é—´æˆ³
    created_at: DateTime
    updated_at: DateTime
```

**ç´¢å¼•ç­–ç•¥**:
- `imagefileid`: å”¯ä¸€ç´¢å¼• (ä¸»æŸ¥è¯¢å­—æ®µ)
- `processing_status`: æ™®é€šç´¢å¼• (çŠ¶æ€ç­›é€‰)
- `business_category`: æ™®é€šç´¢å¼• (åˆ†ç±»ç­›é€‰)
- `created_at`: æ™®é€šç´¢å¼• (æ—¶é—´æ’åº)

#### 6.1.2 KnowledgeBase (çŸ¥è¯†åº“è¡¨)

**ç”¨é€”**: ç®¡ç†å¤šä¸ªçŸ¥è¯†åº“é…ç½®

```python
class KnowledgeBase(Base):
    __tablename__ = "knowledge_bases"
    
    id: Integer (ä¸»é”®)
    
    # åŸºç¡€ä¿¡æ¯
    name: String(200)  # çŸ¥è¯†åº“åç§°
    description: Text  # çŸ¥è¯†åº“æè¿°
    dify_dataset_id: String(100) (å”¯ä¸€, ç´¢å¼•)  # Difyæ•°æ®é›†ID
    
    # é…ç½®ä¿¡æ¯
    api_key: String(500)  # ä¸“ç”¨APIå¯†é’¥
    base_url: String(500)  # ä¸“ç”¨APIåœ°å€
    
    # çŠ¶æ€ä¿¡æ¯
    status: Enum(KnowledgeBaseStatus)  # ACTIVE/INACTIVE/MAINTENANCE
    document_count: Integer  # æ–‡æ¡£æ•°é‡
    last_sync_at: DateTime  # æœ€ååŒæ­¥æ—¶é—´
    
    # æ—¶é—´æˆ³
    created_at: DateTime
    updated_at: DateTime
    
    # å…³ç³»
    category_mappings: relationship("DocumentCategoryMapping")
```

#### 6.1.3 DocumentCategoryMapping (åˆ†ç±»æ˜ å°„è¡¨)

**ç”¨é€”**: é…ç½®ä¸šåŠ¡åˆ†ç±»ä¸çŸ¥è¯†åº“çš„æ˜ å°„å…³ç³»

```python
class DocumentCategoryMapping(Base):
    __tablename__ = "document_category_mappings"
    
    id: Integer (ä¸»é”®)
    
    # å…³è”ä¿¡æ¯
    knowledge_base_id: Integer (å¤–é”® â†’ knowledge_bases.id)
    business_category: Enum(BusinessCategory)
    
    # AIå¤„ç†é…ç½®
    ai_prompt_template: Text  # AIæç¤ºè¯æ¨¡æ¿
    ai_output_schema: Text  # AIè¾“å‡ºJSONæ ¼å¼å®šä¹‰
    processing_priority: Integer (1-10)  # å¤„ç†ä¼˜å…ˆçº§
    
    # è´¨é‡æ§åˆ¶
    min_confidence_score: Integer  # æœ€ä½ç½®ä¿¡åº¦è¦æ±‚
    auto_approve_threshold: Integer  # è‡ªåŠ¨å®¡æ‰¹é˜ˆå€¼
    
    # çŠ¶æ€
    is_active: Boolean
    
    # æ—¶é—´æˆ³
    created_at: DateTime
    updated_at: DateTime
    
    # å…³ç³»
    knowledge_base: relationship("KnowledgeBase")
```

**å”¯ä¸€çº¦æŸ**:
- `(knowledge_base_id, business_category)`: æ¯ä¸ªçŸ¥è¯†åº“çš„åˆ†ç±»æ˜ å°„å”¯ä¸€

#### 6.1.4 ProcessingLog (å¤„ç†æ—¥å¿—è¡¨)

**ç”¨é€”**: è®°å½•æ–‡æ¡£å¤„ç†çš„æ¯ä¸ªæ­¥éª¤

```python
class ProcessingLog(Base):
    __tablename__ = "processing_logs"
    
    id: Integer (ä¸»é”®)
    file_id: String(100) (ç´¢å¼•)  # æ–‡ä»¶ID
    step: String(50)  # å¤„ç†æ­¥éª¤
    status: String(20)  # æ­¥éª¤çŠ¶æ€
    message: Text  # å¤„ç†æ¶ˆæ¯
    duration_seconds: Integer  # å¤„ç†è€—æ—¶
    created_at: DateTime
```

**å…¸å‹æ­¥éª¤**:
- `download`: æ–‡ä»¶ä¸‹è½½
- `decrypt`: æ–‡ä»¶è§£å¯†
- `parse`: å†…å®¹è§£æ
- `ai_analyze`: AI åˆ†æ
- `upload_to_kb`: çŸ¥è¯†åº“ä¸Šä¼ 

### 6.2 æšä¸¾ç±»å‹

#### 6.2.1 ProcessingStatus (å¤„ç†çŠ¶æ€)

```python
class ProcessingStatus(str, Enum):
    PENDING = "PENDING"                # å¾…å¤„ç†
    DOWNLOADING = "DOWNLOADING"        # ä¸‹è½½ä¸­
    DECRYPTING = "DECRYPTING"          # è§£å¯†ä¸­
    PARSING = "PARSING"                # è§£æä¸­
    ANALYZING = "ANALYZING"            # åˆ†æä¸­
    AWAITING_APPROVAL = "AWAITING_APPROVAL"  # å¾…å®¡æ ¸
    COMPLETED = "COMPLETED"            # å·²å®Œæˆ
    FAILED = "FAILED"                  # å¤±è´¥
    SKIPPED = "SKIPPED"                # å·²è·³è¿‡
```

#### 6.2.2 BusinessCategory (ä¸šåŠ¡åˆ†ç±»)

```python
class BusinessCategory(str, Enum):
    HEADQUARTERS_ISSUE = "HEADQUARTERS_ISSUE"        # æ€»è¡Œå‘æ–‡
    RETAIL_ANNOUNCEMENT = "RETAIL_ANNOUNCEMENT"      # é›¶å”®æ¡çº¿å…¬å‘Š
    PUBLICATION_RELEASE = "PUBLICATION_RELEASE"      # åˆŠç‰©å‘å¸ƒ
    BRANCH_ISSUE = "BRANCH_ISSUE"                    # æ”¯è¡Œå‘æ–‡
    BRANCH_RECEIVE = "BRANCH_RECEIVE"                # æ”¯è¡Œæ”¶æ–‡
    PUBLIC_STANDARD = "PUBLIC_STANDARD"              # å…¬å…±å‘å¸ƒåŠè§„èŒƒæ–‡ä»¶
    HEADQUARTERS_RECEIVE = "HEADQUARTERS_RECEIVE"    # æ€»è¡Œæ”¶æ–‡
    CORPORATE_ANNOUNCEMENT = "CORPORATE_ANNOUNCEMENT"  # å…¬å¸æ¡çº¿å…¬å‘Š
```

#### 6.2.3 KnowledgeBaseStatus (çŸ¥è¯†åº“çŠ¶æ€)

```python
class KnowledgeBaseStatus(str, Enum):
    ACTIVE = "ACTIVE"            # æ¿€æ´»
    INACTIVE = "INACTIVE"        # åœç”¨
    MAINTENANCE = "MAINTENANCE"  # ç»´æŠ¤ä¸­
```

### 6.3 æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KnowledgeBase      â”‚
â”‚ (çŸ¥è¯†åº“)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DocumentCategoryMapping    â”‚
â”‚ (åˆ†ç±»æ˜ å°„)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ˜ å°„
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAFileInfo         â”‚          â”‚ ProcessingLog      â”‚
â”‚ (æ–‡ä»¶ä¿¡æ¯)         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (å¤„ç†æ—¥å¿—)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  1:N     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. API ç«¯ç‚¹

### 7.1 æ–‡ä»¶ç®¡ç† API

#### 7.1.1 è·å–æ–‡ä»¶åˆ—è¡¨

```http
GET /api/v1/files/
```

**æŸ¥è¯¢å‚æ•°**:
- `status`: ProcessingStatus (å¯é€‰, æŒ‰çŠ¶æ€ç­›é€‰)
- `category`: BusinessCategory (å¯é€‰, æŒ‰åˆ†ç±»ç­›é€‰)
- `is_zw`: Boolean (å¯é€‰, æ˜¯å¦åªæ˜¾ç¤ºæ­£æ–‡, é»˜è®¤ true)
- `page`: Integer (é¡µç , é»˜è®¤ 1)
- `size`: Integer (æ¯é¡µæ•°é‡, é»˜è®¤ 20, æœ€å¤§ 100)

**å“åº”ç¤ºä¾‹**:
```json
{
  "items": [
    {
      "id": 1,
      "imagefileid": "file-001",
      "filename": "æ–‡æ¡£.pdf",
      "file_type": "pdf",
      "business_category": "HEADQUARTERS_ISSUE",
      "filesize": 1024000,
      "processing_status": "COMPLETED",
      "ai_confidence_score": 85,
      "should_add_to_kb": true,
      "ai_analysis": {...},
      "created_at": "2024-01-01T00:00:00"
    }
  ],
  "total": 100,
  "page": 1,
  "size": 20,
  "pages": 5
}
```

#### 7.1.2 è·å–æ–‡ä»¶è¯¦æƒ…

```http
GET /api/v1/files/{file_id}
```

**å“åº”**: å•ä¸ªæ–‡ä»¶çš„å®Œæ•´ä¿¡æ¯

#### 7.1.3 é‡æ–°å¤„ç†æ–‡ä»¶

```http
POST /api/v1/files/{file_id}/reprocess
```

**åŠŸèƒ½**: é‡æ–°å¯åŠ¨æ–‡ä»¶å¤„ç†æµç¨‹

### 7.2 å¤„ç†ä»»åŠ¡ API

#### 7.2.1 æäº¤å¤„ç†ä»»åŠ¡

```http
POST /api/v1/process
```

**è¯·æ±‚ä½“**:
```json
{
  "file_id": "file-001"
}
```

**å“åº”**:
```json
{
  "task_id": "celery-task-uuid",
  "message": "ä»»åŠ¡å·²æäº¤",
  "file_id": "file-001"
}
```

#### 7.2.2 æ‰¹é‡å¤„ç†

```http
POST /api/v1/batch-process
```

**è¯·æ±‚ä½“**:
```json
{
  "file_ids": ["file-001", "file-002", "file-003"]
}
```

#### 7.2.3 å¤„ç†æ‰€æœ‰å¾…å¤„ç†æ–‡ä»¶

```http
POST /api/v1/process-all-pending
```

**åŠŸèƒ½**: å¤„ç†æ‰€æœ‰çŠ¶æ€ä¸º PENDING çš„æ–‡ä»¶

### 7.3 å®¡æ‰¹æµç¨‹ API

#### 7.3.1 å®¡æ‰¹æ–‡æ¡£

```http
POST /api/v1/approve
```

**è¯·æ±‚ä½“**:
```json
{
  "file_id": "file-001",
  "approved": true,
  "comment": "å®¡æ ¸é€šè¿‡"
}
```

#### 7.3.2 æ‰¹é‡å®¡æ‰¹

```http
POST /api/v1/batch-approve
```

**è¯·æ±‚ä½“**:
```json
{
  "file_ids": ["file-001", "file-002"],
  "approved": true
}
```

#### 7.3.3 è·å–å¾…å®¡æ ¸åˆ—è¡¨

```http
GET /api/v1/files/?status=AWAITING_APPROVAL
```

### 7.4 ç»Ÿè®¡ä¸ç›‘æ§ API

#### 7.4.1 ç»Ÿè®¡æ¦‚è§ˆ

```http
GET /api/v1/stats/overview
```

**å“åº”**:
```json
{
  "total_files": 1000,
  "pending": 50,
  "processing": 10,
  "completed": 800,
  "failed": 20,
  "awaiting_approval": 30,
  "success_rate": 95.0,
  "avg_processing_time": 45.5
}
```

#### 7.4.2 æŒ‰åˆ†ç±»ç»Ÿè®¡

```http
GET /api/v1/stats/by-category
```

**å“åº”**:
```json
{
  "HEADQUARTERS_ISSUE": {
    "total": 200,
    "completed": 180,
    "success_rate": 90.0
  },
  "RETAIL_ANNOUNCEMENT": {
    "total": 150,
    "completed": 140,
    "success_rate": 93.3
  }
}
```

#### 7.4.3 å¤„ç†æ—¥å¿—

```http
GET /api/v1/logs/{file_id}
```

**å“åº”**:
```json
{
  "logs": [
    {
      "step": "download",
      "status": "success",
      "message": "ä¸‹è½½æˆåŠŸ",
      "duration_seconds": 5,
      "created_at": "2024-01-01T00:00:00"
    },
    {
      "step": "ai_analyze",
      "status": "success",
      "message": "åˆ†æå®Œæˆ",
      "duration_seconds": 20,
      "created_at": "2024-01-01T00:00:05"
    }
  ]
}
```

### 7.5 ç³»ç»Ÿç›‘æ§ API

#### 7.5.1 å¥åº·æ£€æŸ¥

```http
GET /health
```

**å“åº”**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00"
}
```

#### 7.5.2 ç³»ç»Ÿå¿«ç…§

```http
GET /api/v1/system/snapshot
```

**å“åº”**: åŒ…å«æ•°æ®åº“ã€Redisã€S3 è¿æ¥çŠ¶æ€

#### 7.5.3 é˜Ÿåˆ—ç»Ÿè®¡

```http
GET /api/v1/system/queue-stats
```

**å“åº”**: Celery é˜Ÿåˆ—é•¿åº¦å’Œ worker çŠ¶æ€

#### 7.5.4 æœ€è¿‘æ´»åŠ¨

```http
GET /api/v1/system/recent-activity
```

**å“åº”**: æœ€è¿‘çš„æ–‡ä»¶å¤„ç†æ´»åŠ¨

#### 7.5.5 æœ€è¿‘é”™è¯¯

```http
GET /api/v1/system/recent-errors
```

**å“åº”**: æœ€è¿‘çš„å¤„ç†é”™è¯¯åˆ—è¡¨

### 7.6 çŸ¥è¯†åº“ç®¡ç† API

#### 7.6.1 è·å–çŸ¥è¯†åº“åˆ—è¡¨

```http
GET /api/v1/knowledge-bases/
```

#### 7.6.2 åŒæ­¥åˆ°çŸ¥è¯†åº“

```http
POST /api/v1/files/{file_id}/sync-to-kb
```

**åŠŸèƒ½**: æ‰‹åŠ¨å°†æ–‡ä»¶åŒæ­¥åˆ°çŸ¥è¯†åº“

### 7.7 å¯¼å‡ºåŠŸèƒ½ API

#### 7.7.1 å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š (CSV)

```http
GET /api/v1/export/stats
```

**å“åº”**: CSV æ–‡ä»¶ä¸‹è½½

#### 7.7.2 å¯¼å‡ºå¤„ç†æ—¥å¿— (CSV)

```http
GET /api/v1/export/logs?file_id={file_id}
```

---

## 8. ä¸šåŠ¡æµç¨‹

### 8.1 å®Œæ•´å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–‡æ¡£å¤„ç†å®Œæ•´æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. æ–‡æ¡£åŒæ­¥åˆ°æ•°æ®åº“
   â†“
   Status: PENDING

2. è§¦å‘å¤„ç†ä»»åŠ¡
   â†“
   Celery Task: process_document(file_id)

3. ä¸‹è½½æ–‡ä»¶
   â†“
   Status: DOWNLOADING
   Service: s3_service.download_file()
   â†“
   æˆåŠŸ: è·å¾— file_data (bytes)
   å¤±è´¥: Status â†’ FAILED, è®°å½•é”™è¯¯

4. è§£å¯†æ–‡ä»¶ (å¦‚æœéœ€è¦)
   â†“
   Status: DECRYPTING
   Service: decryption_service.decrypt()
   â†“
   æˆåŠŸ: è·å¾— decrypted_data (bytes)
   å¤±è´¥: Status â†’ FAILED

5. è§£ææ–‡æ¡£å†…å®¹
   â†“
   Status: PARSING
   Service: api_document_parser.parse_document()
   â†“
   æˆåŠŸ: è·å¾— content (str), metadata (dict)
   å¤±è´¥: Status â†’ FAILED

6. AI åˆ†æ
   â†“
   Status: ANALYZING
   Service: ai_analyzer.analyze_document_content()
   â†“
   æˆåŠŸ: è·å¾— analysis_result, confidence_score
   å¤±è´¥: Status â†’ FAILED

7. è´¨é‡æ£€æŸ¥ä¸è·¯ç”±
   â†“
   åˆ†æå™¨: multi_kb_manager.get_target_knowledge_base()
   â†“
   ç¡®å®šç›®æ ‡çŸ¥è¯†åº“: target_kb

8. å®¡æ‰¹å†³ç­–
   â†“
   IF confidence_score >= auto_approve_threshold:
      è‡ªåŠ¨å®¡æ‰¹
      â†“
      è·³åˆ°æ­¥éª¤ 10
   ELSE:
      äººå·¥å®¡æ ¸
      â†“
      Status: AWAITING_APPROVAL
      â†“
      ç­‰å¾…äººå·¥æ“ä½œ...

9. äººå·¥å®¡æ ¸ (å¯é€‰)
   â†“
   æ“ä½œ: approve_document(file_id, approved=True/False)
   â†“
   IF approved == False:
      Status â†’ SKIPPED
      æµç¨‹ç»“æŸ
   ELSE:
      ç»§ç»­

10. ä¸Šä¼ åˆ°çŸ¥è¯†åº“
    â†“
    IF should_add_to_kb == True:
       Service: dify_service.add_document_to_knowledge_base()
       â†“
       æˆåŠŸ: è·å¾— document_id
       å¤±è´¥: Status â†’ FAILED
    ELSE:
       è·³è¿‡ä¸Šä¼ 

11. æ›´æ–°çŠ¶æ€
    â†“
    Status: COMPLETED
    æ›´æ–° processing_completed_at
    è®°å½• document_id

12. è®°å½•æ—¥å¿—
    â†“
    ProcessingLog: è®°å½•æ¯ä¸ªæ­¥éª¤çš„è€—æ—¶å’Œç»“æœ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æµç¨‹ç»“æŸ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å…³é”®å†³ç­–ç‚¹

#### 8.2.1 æ˜¯å¦è§£å¯†?

```python
if file_info.asecode:
    # éœ€è¦è§£å¯†
    decrypted_data = decryption_service.decrypt(file_data, file_info.asecode)
else:
    # æ— éœ€è§£å¯†
    decrypted_data = file_data
```

#### 8.2.2 æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸?

```python
if analysis_result['confidence_score'] >= auto_approve_threshold:
    # è‡ªåŠ¨å®¡æ‰¹
    approved = True
else:
    # éœ€è¦äººå·¥å®¡æ ¸
    update_file_status(file_id, ProcessingStatus.AWAITING_APPROVAL)
    return  # ç­‰å¾…äººå·¥æ“ä½œ
```

#### 8.2.3 é€‰æ‹©ç›®æ ‡çŸ¥è¯†åº“

```python
target_kb = multi_kb_manager.get_target_knowledge_base(
    business_category=file_info.business_category
)

if target_kb:
    # ä½¿ç”¨ç‰¹å®šçŸ¥è¯†åº“
    dify_service = DifyService.create_for_knowledge_base(target_kb)
else:
    # ä½¿ç”¨é»˜è®¤çŸ¥è¯†åº“
    dify_service = DifyService()
```

### 8.3 é”™è¯¯å¤„ç†ç­–ç•¥

#### 8.3.1 é‡è¯•æœºåˆ¶

```python
@app.task(bind=True, max_retries=3, default_retry_delay=300)
def process_document(self, file_id: str):
    try:
        # å¤„ç†é€»è¾‘
        ...
    except Exception as exc:
        # è®°å½•é”™è¯¯
        file_info.error_count += 1
        file_info.last_error = str(exc)
        
        # é‡è¯•
        if self.request.retries < self.max_retries:
            raise self.retry(exc=exc)
        else:
            # æœ€ç»ˆå¤±è´¥
            update_file_status(file_id, ProcessingStatus.FAILED)
```

**é‡è¯•å‚æ•°**:
- `max_retries`: 3 æ¬¡
- `default_retry_delay`: 300 ç§’ (5 åˆ†é’Ÿ)
- é‡è¯•é—´éš”: æŒ‡æ•°é€€é¿ç­–ç•¥

#### 8.3.2 é”™è¯¯åˆ†ç±»

1. **æš‚æ—¶æ€§é”™è¯¯** (å¯é‡è¯•):
   - ç½‘ç»œè¿æ¥å¤±è´¥
   - API é™æµ
   - ä¸´æ—¶æœåŠ¡ä¸å¯ç”¨

2. **æ°¸ä¹…æ€§é”™è¯¯** (ä¸é‡è¯•):
   - æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ
   - æ–‡ä»¶æŸå
   - è®¤è¯å¤±è´¥

3. **ä¸šåŠ¡é”™è¯¯** (éœ€äººå·¥å¤„ç†):
   - AI åˆ†æç½®ä¿¡åº¦è¿‡ä½
   - å†…å®¹è¿è§„
   - é‡å¤æ–‡ä»¶

### 8.4 æ€§èƒ½ä¼˜åŒ–

#### 8.4.1 æ‰¹é‡å¤„ç†

```python
@app.task
def batch_process_documents(file_ids: List[str]):
    """æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡æ¡£"""
    for file_id in file_ids:
        process_document.delay(file_id)
```

**ä¼˜åŠ¿**:
- å¹¶è¡Œå¤„ç†
- å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€
- æé«˜ååé‡

#### 8.4.2 ä»»åŠ¡é˜Ÿåˆ—ä¼˜åŒ–

```python
# ä»»åŠ¡è·¯ç”±é…ç½®
task_routes = {
    'process_document': {'queue': 'document_processing'},
    'batch_process': {'queue': 'batch_processing'},
    'approve_document': {'queue': 'document_processing'},
}
```

**é˜Ÿåˆ—ç­–ç•¥**:
- `document_processing`: é«˜ä¼˜å…ˆçº§ï¼Œå•æ–‡æ¡£å¤„ç†
- `batch_processing`: ä½ä¼˜å…ˆçº§ï¼Œæ‰¹é‡å¤„ç†

---

## 9. ä»£ç è´¨é‡è¯„ä¼°

### 9.1 ä»£ç é£æ ¼

#### 9.1.1 ä¼˜ç‚¹

âœ… **ç±»å‹æç¤º**:
```python
def analyze_document_content(
    self, 
    content: str, 
    filename: str, 
    file_info: Dict, 
    metadata: Dict
) -> Tuple[Dict, Optional[KnowledgeBase]]:
    ...
```
- å¹¿æ³›ä½¿ç”¨ç±»å‹æç¤º
- æé«˜ä»£ç å¯è¯»æ€§
- ä¾¿äº IDE è‡ªåŠ¨è¡¥å…¨

âœ… **Pydantic æ•°æ®éªŒè¯**:
```python
class Settings(BaseSettings):
    database_url: str = Field(...)
    openai_api_key: str = Field(...)
    
    class Config:
        env_file = ".env"
```
- é…ç½®ç®¡ç†è§„èŒƒ
- è‡ªåŠ¨ç¯å¢ƒå˜é‡åŠ è½½
- æ•°æ®éªŒè¯

âœ… **æšä¸¾ç±»å‹ä½¿ç”¨**:
```python
class ProcessingStatus(str, Enum):
    PENDING = "PENDING"
    COMPLETED = "COMPLETED"
```
- ç±»å‹å®‰å…¨
- é¿å…é­”æ³•å­—ç¬¦ä¸²
- IDE æ”¯æŒ

#### 9.1.2 éœ€è¦æ”¹è¿›

âš ï¸ **æ—¥å¿—è®°å½•ä¸ä¸€è‡´**:
```python
# æœ‰äº›åœ°æ–¹ä½¿ç”¨ logger
logger.info(f"å¤„ç†æ–‡æ¡£: {file_id}")

# æœ‰äº›åœ°æ–¹ä½¿ç”¨ print
print("é”™è¯¯ä¿¡æ¯")  # âŒ åº”ä½¿ç”¨ logger
```

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `logging` æ¨¡å—

âš ï¸ **å¼‚å¸¸å¤„ç†ç²’åº¦**:
```python
try:
    # å¤§æ®µä»£ç 
    ...
except Exception as e:  # âŒ æ•è·èŒƒå›´è¿‡å¤§
    logger.error(f"é”™è¯¯: {e}")
```

**å»ºè®®**: æ•è·å…·ä½“å¼‚å¸¸ç±»å‹

âš ï¸ **é­”æ³•æ•°å­—**:
```python
content_preview = content[:2000]  # âŒ ç¡¬ç¼–ç 
```

**å»ºè®®**: ä½¿ç”¨é…ç½®å¸¸é‡
```python
CONTENT_PREVIEW_LENGTH = 2000
content_preview = content[:CONTENT_PREVIEW_LENGTH]
```

### 9.2 æ¶æ„è®¾è®¡

#### 9.2.1 ä¼˜ç‚¹

âœ… **æœåŠ¡åˆ†å±‚æ¸…æ™°**:
```
Presentation â†’ Business â†’ Data â†’ Integration
```

âœ… **å•ä¸€èŒè´£åŸåˆ™**:
- æ¯ä¸ªæœåŠ¡ä¸“æ³¨å•ä¸€åŠŸèƒ½
- `S3Service`: åªè´Ÿè´£ S3 æ“ä½œ
- `AIAnalyzer`: åªè´Ÿè´£ AI åˆ†æ

âœ… **ä¾èµ–æ³¨å…¥**:
```python
class DifyService:
    def __init__(self, knowledge_base: Optional[KnowledgeBase] = None):
        ...
```

âœ… **å·¥å‚æ¨¡å¼**:
```python
@classmethod
def create_for_knowledge_base(cls, kb: KnowledgeBase) -> 'DifyService':
    return cls(knowledge_base=kb)
```

#### 9.2.2 éœ€è¦æ”¹è¿›

âš ï¸ **å…¨å±€å•ä¾‹**:
```python
s3_service = S3Service()  # æ¨¡å—çº§å•ä¾‹
ai_analyzer = AIAnalyzer()
```

**é—®é¢˜**: éš¾ä»¥æµ‹è¯•å’Œæ›¿æ¢

**å»ºè®®**: ä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨æˆ–å·¥å‚å‡½æ•°

âš ï¸ **ç´§è€¦åˆ**:
```python
def process_document(file_id: str):
    # ç›´æ¥è°ƒç”¨å…¨å±€æœåŠ¡
    file_data = s3_service.download_file(...)
    result = ai_analyzer.analyze(...)
```

**å»ºè®®**: é€šè¿‡å‚æ•°ä¼ é€’æœåŠ¡å®ä¾‹

### 9.3 æµ‹è¯•è¦†ç›–ç‡

#### 9.3.1 ç°çŠ¶

ğŸ“Š **æµ‹è¯•æ–‡ä»¶**: 1 ä¸ª (`test_api_parser.py`)

âš ï¸ **é—®é¢˜**:
- ç¼ºå°‘å•å…ƒæµ‹è¯•
- ç¼ºå°‘é›†æˆæµ‹è¯•
- ç¼ºå°‘ç«¯åˆ°ç«¯æµ‹è¯•

#### 9.3.2 å»ºè®®

**å•å…ƒæµ‹è¯•** (ä¼˜å…ˆçº§: é«˜):
```python
# tests/test_ai_analyzer.py
def test_analyze_document_content():
    analyzer = AIAnalyzer()
    result, kb = analyzer.analyze_document_content(...)
    assert result['suitable_for_kb'] is True
    assert result['confidence_score'] > 0
```

**é›†æˆæµ‹è¯•** (ä¼˜å…ˆçº§: ä¸­):
```python
# tests/test_document_processor.py
def test_process_document_flow():
    # æ¨¡æ‹Ÿå®Œæ•´æµç¨‹
    result = process_document.apply(args=['test-file-id']).get()
    assert result['success'] is True
```

**ç«¯åˆ°ç«¯æµ‹è¯•** (ä¼˜å…ˆçº§: ä½):
```python
# tests/test_e2e.py
def test_full_workflow(test_client):
    # æäº¤ä»»åŠ¡
    response = test_client.post('/api/v1/process', json={'file_id': 'test-001'})
    assert response.status_code == 200
```

### 9.4 æ€§èƒ½è€ƒè™‘

#### 9.4.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

âœ… **å·²å®ç°**:
- ç´¢å¼•ä¼˜åŒ– (imagefileid, processing_status)
- åˆ†é¡µæŸ¥è¯¢
- ä½¿ç”¨ ORM æ‡’åŠ è½½

âš ï¸ **éœ€è¦æ”¹è¿›**:
```python
# âŒ N+1 æŸ¥è¯¢é—®é¢˜
for file in files:
    logs = db.query(ProcessingLog).filter_by(file_id=file.id).all()
```

**å»ºè®®**: ä½¿ç”¨ `joinedload` æˆ–é¢„åŠ è½½
```python
files = db.query(OAFileInfo).options(
    joinedload(OAFileInfo.processing_logs)
).all()
```

#### 9.4.2 ç¼“å­˜ç­–ç•¥

âš ï¸ **å½“å‰æ— ç¼“å­˜æœºåˆ¶**

**å»ºè®®å®ç°**:
1. **Redis ç¼“å­˜**:
   - é¢‘ç¹è®¿é—®çš„ç»Ÿè®¡æ•°æ®
   - AI åˆ†æç»“æœ
   - çŸ¥è¯†åº“é…ç½®

2. **åº”ç”¨å±‚ç¼“å­˜**:
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_knowledge_base_config(kb_id: int):
    return db.query(KnowledgeBase).get(kb_id)
```

#### 9.4.3 å¼‚æ­¥ I/O

âœ… **å·²ä½¿ç”¨ Celery å¼‚æ­¥ä»»åŠ¡**

âš ï¸ **å¯ä»¥ä¼˜åŒ–**:
- API å±‚ä½¿ç”¨ `async/await`
- æ•°æ®åº“æ“ä½œä½¿ç”¨å¼‚æ­¥é©±åŠ¨ (asyncpg)

### 9.5 å®‰å…¨æ€§

#### 9.5.1 ä¼˜ç‚¹

âœ… **ç¯å¢ƒå˜é‡ç®¡ç†**:
- æ•æ„Ÿä¿¡æ¯é€šè¿‡ `.env` é…ç½®
- ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

âœ… **SQL æ³¨å…¥é˜²æŠ¤**:
- ä½¿ç”¨ ORM å‚æ•°åŒ–æŸ¥è¯¢

#### 9.5.2 éœ€è¦æ”¹è¿›

âš ï¸ **API æ— è®¤è¯æœºåˆ¶**:
```python
@router.get("/files/")
async def get_files(...):
    # âŒ æ— è®¤è¯æ£€æŸ¥
```

**å»ºè®®**: æ·»åŠ  JWT æˆ– API Key è®¤è¯
```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer

security = HTTPBearer()

@router.get("/files/")
async def get_files(token: str = Depends(security)):
    # éªŒè¯ token
    if not verify_token(token):
        raise HTTPException(status_code=401)
```

âš ï¸ **è¾“å…¥éªŒè¯ä¸è¶³**:
```python
@router.post("/approve")
async def approve_document(file_id: str, approved: bool):
    # âŒ ç¼ºå°‘è¯¦ç»†éªŒè¯
```

**å»ºè®®**: ä½¿ç”¨ Pydantic æ¨¡å‹
```python
class ApproveRequest(BaseModel):
    file_id: str = Field(..., min_length=1, max_length=100)
    approved: bool
    comment: Optional[str] = Field(None, max_length=500)

@router.post("/approve")
async def approve_document(request: ApproveRequest):
    ...
```

âš ï¸ **æ—¥å¿—æ•æ„Ÿä¿¡æ¯**:
```python
logger.info(f"API Key: {api_key}")  # âŒ æ³„éœ²æ•æ„Ÿä¿¡æ¯
```

**å»ºè®®**: è„±æ•å¤„ç†
```python
def mask_sensitive(value: str) -> str:
    return value[:4] + '*' * (len(value) - 8) + value[-4:]

logger.info(f"API Key: {mask_sensitive(api_key)}")
```

---

## 10. æ–‡æ¡£ç°çŠ¶

### 10.1 ç°æœ‰æ–‡æ¡£è¯„ä¼°

#### 10.1.1 README.md (479 è¡Œ) â­â­â­â­â­

**ä¼˜ç‚¹**:
- âœ… ç»“æ„å®Œæ•´æ¸…æ™°
- âœ… åŒ…å«ç³»ç»Ÿæ¶æ„å›¾
- âœ… è¯¦ç»†çš„å®‰è£…éƒ¨ç½²æŒ‡å—
- âœ… ä¸°å¯Œçš„é…ç½®è¯´æ˜
- âœ… æ•…éšœæ’é™¤æŒ‡å—
- âœ… ä½¿ç”¨ç¤ºä¾‹

**å†…å®¹è¦†ç›–**:
- åŠŸèƒ½ç‰¹æ€§
- ç³»ç»Ÿè¦æ±‚
- å®‰è£…æ­¥éª¤
- é…ç½®è¯´æ˜
- Docker éƒ¨ç½²
- API ä½¿ç”¨
- æ•…éšœæ’é™¤
- å¼€å‘æŒ‡å—

**è¯„åˆ†**: 5/5 (éå¸¸å®Œå–„)

#### 10.1.2 AI_CONFIG.md (235 è¡Œ) â­â­â­â­â˜†

**ä¼˜ç‚¹**:
- âœ… AI é…ç½®è¯¦ç»†è¯´æ˜
- âœ… æ•°æ®åº“é…ç½®ç¤ºä¾‹
- âœ… åˆ†ç±»ç‰¹å®šå­—æ®µè¯´æ˜
- âœ… è‡ªå®šä¹‰æç¤ºè¯ç¤ºä¾‹

**éœ€è¦è¡¥å……**:
- âš ï¸ AI æ¨¡å‹é€‰æ‹©å»ºè®®
- âš ï¸ æ€§èƒ½ä¼˜åŒ–å»ºè®®
- âš ï¸ æç¤ºè¯æœ€ä½³å®è·µ

**è¯„åˆ†**: 4/5 (è‰¯å¥½)

#### 10.1.3 dify_api.md (113 è¡Œ) â­â­â­â˜†â˜†

**ä¼˜ç‚¹**:
- âœ… Dify API ä½¿ç”¨è¯´æ˜
- âœ… æ¥å£ç¤ºä¾‹

**éœ€è¦è¡¥å……**:
- âš ï¸ é”™è¯¯å¤„ç†è¯´æ˜
- âš ï¸ API é™æµç­–ç•¥
- âš ï¸ æœ€ä½³å®è·µ

**è¯„åˆ†**: 3/5 (åŸºæœ¬)

#### 10.1.4 ä»£ç æ³¨é‡Š â­â­â­â˜†â˜†

**ç°çŠ¶**:
- âœ… éƒ¨åˆ†å‡½æ•°æœ‰ docstring
- âš ï¸ æ³¨é‡Šè¦†ç›–ç‡ä¸å‡è¡¡
- âš ï¸ ç¼ºå°‘å¤æ‚é€»è¾‘è¯´æ˜

**ç¤ºä¾‹** (å¥½çš„æ³¨é‡Š):
```python
def analyze_document_content(
    self, 
    content: str, 
    filename: str, 
    file_info: Dict, 
    metadata: Dict
) -> Tuple[Dict, Optional[KnowledgeBase]]:
    """
    åˆ†ææ–‡æ¡£å†…å®¹å¹¶ç¡®å®šç›®æ ‡çŸ¥è¯†åº“
    
    Args:
        content: æ–‡æ¡£æ–‡æœ¬å†…å®¹
        filename: æ–‡ä»¶å
        file_info: æ–‡ä»¶ä¿¡æ¯å­—å…¸
        metadata: æ–‡æ¡£å…ƒæ•°æ®
    
    Returns:
        Tuple[Dict, Optional[KnowledgeBase]]: 
            (åˆ†æç»“æœ, ç›®æ ‡çŸ¥è¯†åº“)
    """
```

**è¯„åˆ†**: 3/5 (éœ€è¦æ”¹è¿›)

### 10.2 ç¼ºå¤±çš„æ–‡æ¡£

#### 10.2.1 API æ–‡æ¡£

âš ï¸ **éœ€è¦è¡¥å……**:
- å®Œæ•´çš„ API ç«¯ç‚¹æ–‡æ¡£
- è¯·æ±‚/å“åº”ç¤ºä¾‹
- é”™è¯¯ç è¯´æ˜
- è®¤è¯æ–¹å¼

**å»ºè®®**: ä½¿ç”¨ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ (`/docs`)ï¼Œä½†éœ€è¦è¡¥å……æ›´å¤šè¯´æ˜

#### 10.2.2 æ¶æ„è®¾è®¡æ–‡æ¡£

âš ï¸ **éœ€è¦è¡¥å……**:
- ç³»ç»Ÿè®¾è®¡å†³ç­–
- æ¶æ„æƒè¡¡
- æ‰©å±•æ€§è®¾è®¡
- æ€§èƒ½åŸºå‡†

#### 10.2.3 å¼€å‘æŒ‡å—

âš ï¸ **éœ€è¦è¡¥å……**:
- æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º
- ä»£ç æäº¤è§„èŒƒ
- æµ‹è¯•ç¼–å†™æŒ‡å—
- è°ƒè¯•æŠ€å·§

#### 10.2.4 è¿ç»´æ‰‹å†Œ

âš ï¸ **éœ€è¦è¡¥å……**:
- éƒ¨ç½²æµç¨‹
- ç›‘æ§å‘Šè­¦
- å¤‡ä»½æ¢å¤
- æ‰©å®¹æ–¹æ¡ˆ
- æ•…éšœæ¢å¤æµç¨‹

### 10.3 æ–‡æ¡£æ”¹è¿›å»ºè®®

#### 10.3.1 çŸ­æœŸ (1-2 å‘¨)

1. **è¡¥å……ä»£ç æ³¨é‡Š**:
   - ä¸ºæ‰€æœ‰å…¬å…±å‡½æ•°æ·»åŠ  docstring
   - è§£é‡Šå¤æ‚ç®—æ³•å’Œä¸šåŠ¡é€»è¾‘

2. **å®Œå–„ API æ–‡æ¡£**:
   - ä¸ºæ¯ä¸ªç«¯ç‚¹æ·»åŠ è¯¦ç»†æè¿°
   - è¡¥å……è¯·æ±‚/å“åº”ç¤ºä¾‹

3. **æ·»åŠ å¿«é€Ÿå¼€å§‹æŒ‡å—**:
   - 5 åˆ†é’Ÿå¿«é€Ÿä½“éªŒ
   - å¸¸è§åœºæ™¯ç¤ºä¾‹

#### 10.3.2 ä¸­æœŸ (1-2 æœˆ)

1. **ç¼–å†™æ¶æ„è®¾è®¡æ–‡æ¡£**:
   - è®¾è®¡å†³ç­–è®°å½• (ADR)
   - æ¶æ„æƒè¡¡åˆ†æ

2. **è¡¥å……å¼€å‘æŒ‡å—**:
   - è´¡çŒ®æŒ‡å—
   - ä»£ç å®¡æŸ¥æ¸…å•

3. **ç¼–å†™æµ‹è¯•æ–‡æ¡£**:
   - æµ‹è¯•ç­–ç•¥
   - æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

#### 10.3.3 é•¿æœŸ (3-6 æœˆ)

1. **ç¼–å†™è¿ç»´æ‰‹å†Œ**:
   - éƒ¨ç½²è‡ªåŠ¨åŒ–
   - ç›‘æ§ä½“ç³»
   - æ•…éšœå¤„ç†æµç¨‹

2. **è§†é¢‘æ•™ç¨‹**:
   - ç³»ç»Ÿæ¼”ç¤º
   - å¼€å‘æ•™ç¨‹

3. **æ¡ˆä¾‹ç ”ç©¶**:
   - å…¸å‹åº”ç”¨åœºæ™¯
   - æœ€ä½³å®è·µ

---

## 11. æ”¹è¿›å»ºè®®

### 11.1 ä»£ç è´¨é‡æ”¹è¿›

#### 11.1.1 ä¼˜å…ˆçº§: é«˜

**1. æ·»åŠ å•å…ƒæµ‹è¯•**

```python
# tests/services/test_ai_analyzer.py
import pytest
from services.ai_analyzer import AIAnalyzer, DocumentProcessor

class TestAIAnalyzer:
    @pytest.fixture
    def analyzer(self):
        return AIAnalyzer()
    
    def test_analyze_suitable_document(self, analyzer):
        result, kb = analyzer.analyze_document_content(
            content="é«˜è´¨é‡çš„æ–‡æ¡£å†…å®¹...",
            filename="test.pdf",
            file_info={'business_category': 'HEADQUARTERS_ISSUE'},
            metadata={'file_type': 'pdf'}
        )
        assert result['suitable_for_kb'] is True
        assert result['confidence_score'] > 70
    
    def test_analyze_unsuitable_document(self, analyzer):
        result, kb = analyzer.analyze_document_content(
            content="æµ‹è¯•æ–‡æ¡£",
            filename="test.txt",
            file_info={'business_category': 'HEADQUARTERS_ISSUE'},
            metadata={'file_type': 'txt'}
        )
        assert result['suitable_for_kb'] is False
```

**2. ç»Ÿä¸€æ—¥å¿—è®°å½•**

```python
# utils/logger.py
import logging
from logging.handlers import RotatingFileHandler

def setup_logger(name: str) -> logging.Logger:
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)
    
    # æ–‡ä»¶å¤„ç†å™¨
    fh = RotatingFileHandler(
        f'logs/{name}.log',
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    fh.setLevel(logging.INFO)
    
    # æ ¼å¼åŒ–
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    fh.setFormatter(formatter)
    
    logger.addHandler(fh)
    return logger
```

**3. æ·»åŠ  API è®¤è¯**

```python
# utils/auth.py
from fastapi import HTTPException, Security
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def verify_token(
    credentials: HTTPAuthorizationCredentials = Security(security)
) -> bool:
    token = credentials.credentials
    # éªŒè¯é€»è¾‘
    if not is_valid_token(token):
        raise HTTPException(status_code=401, detail="Invalid token")
    return True

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨
@router.get("/files/", dependencies=[Depends(verify_token)])
async def get_files(...):
    ...
```

#### 11.1.2 ä¼˜å…ˆçº§: ä¸­

**4. é…ç½®å¸¸é‡åŒ–**

```python
# constants.py
class DocumentProcessing:
    CONTENT_PREVIEW_LENGTH = 2000
    MAX_RETRY_COUNT = 3
    RETRY_DELAY_SECONDS = 300
    MAX_FILE_SIZE_MB = 100
    SUPPORTED_FORMATS = ['pdf', 'docx', 'doc', 'txt']

class AIAnalysis:
    DEFAULT_MODEL = "gpt-4"
    MAX_TOKENS = 4000
    TEMPERATURE = 0.7
    MIN_CONFIDENCE_SCORE = 70
    AUTO_APPROVE_THRESHOLD = 90
```

**5. æ·»åŠ è¾“å…¥éªŒè¯**

```python
# api/schemas.py
from pydantic import BaseModel, Field, validator

class ProcessRequest(BaseModel):
    file_id: str = Field(..., min_length=1, max_length=100, description="æ–‡ä»¶ID")
    priority: int = Field(default=5, ge=1, le=10, description="ä¼˜å…ˆçº§")
    
    @validator('file_id')
    def validate_file_id(cls, v):
        if not v.isalnum() and '-' not in v:
            raise ValueError('Invalid file_id format')
        return v

class ApproveRequest(BaseModel):
    file_id: str = Field(..., min_length=1, max_length=100)
    approved: bool
    comment: Optional[str] = Field(None, max_length=500)
```

**6. å®ç°ç¼“å­˜æœºåˆ¶**

```python
# utils/cache.py
import redis
import json
from functools import wraps

redis_client = redis.from_url(settings.redis_url)

def cache_result(expire_seconds: int = 300):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜é”®
            cache_key = f"{func.__name__}:{args}:{kwargs}"
            
            # å°è¯•ä»ç¼“å­˜è·å–
            cached = redis_client.get(cache_key)
            if cached:
                return json.loads(cached)
            
            # æ‰§è¡Œå‡½æ•°
            result = func(*args, **kwargs)
            
            # å­˜å…¥ç¼“å­˜
            redis_client.setex(
                cache_key,
                expire_seconds,
                json.dumps(result)
            )
            
            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@cache_result(expire_seconds=600)
def get_statistics():
    # è€—æ—¶çš„ç»Ÿè®¡æŸ¥è¯¢
    ...
```

#### 11.1.3 ä¼˜å…ˆçº§: ä½

**7. å®ç°ä¾èµ–æ³¨å…¥**

```python
# core/dependencies.py
from typing import Annotated
from fastapi import Depends

def get_s3_service() -> S3Service:
    return S3Service()

def get_ai_analyzer() -> AIAnalyzer:
    return AIAnalyzer()

def get_dify_service(
    knowledge_base: Optional[KnowledgeBase] = None
) -> DifyService:
    return DifyService(knowledge_base)

# ä½¿ç”¨ç¤ºä¾‹
@router.post("/process")
async def process_document(
    file_id: str,
    s3_service: Annotated[S3Service, Depends(get_s3_service)],
    ai_analyzer: Annotated[AIAnalyzer, Depends(get_ai_analyzer)]
):
    ...
```

**8. æ·»åŠ æ€§èƒ½ç›‘æ§**

```python
# utils/performance.py
import time
from functools import wraps

def track_performance(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        duration = time.time() - start_time
        
        logger.info(
            f"Performance: {func.__name__} took {duration:.2f}s"
        )
        
        # ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
        # metrics.report(func.__name__, duration)
        
        return result
    return wrapper
```

### 11.2 åŠŸèƒ½å¢å¼º

#### 11.2.1 çŸ­æœŸ (1-2 æœˆ)

**1. æ”¯æŒæ›´å¤šæ–‡æ¡£æ ¼å¼**

- Excel (xlsx, xls)
- PowerPoint (pptx, ppt)
- Markdown
- HTML

**å®ç°æ€è·¯**:
```python
# services/format_handlers/
â”œâ”€â”€ excel_handler.py
â”œâ”€â”€ ppt_handler.py
â”œâ”€â”€ markdown_handler.py
â””â”€â”€ html_handler.py

class FormatHandler(ABC):
    @abstractmethod
    def can_handle(self, file_type: str) -> bool:
        pass
    
    @abstractmethod
    def extract_content(self, file_data: bytes) -> str:
        pass

class ExcelHandler(FormatHandler):
    def can_handle(self, file_type: str) -> bool:
        return file_type in ['xlsx', 'xls']
    
    def extract_content(self, file_data: bytes) -> str:
        # ä½¿ç”¨ openpyxl æˆ– pandas æå–
        ...
```

**2. æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†**

- è®°å½•æ–‡æ¡£ä¿®æ”¹å†å²
- æ”¯æŒç‰ˆæœ¬å›æ»š
- ç‰ˆæœ¬å·®å¼‚å¯¹æ¯”

**æ•°æ®åº“è®¾è®¡**:
```sql
CREATE TABLE document_versions (
    id SERIAL PRIMARY KEY,
    file_id VARCHAR(100) NOT NULL,
    version_number INTEGER NOT NULL,
    content TEXT,
    ai_analysis_result TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (file_id) REFERENCES oa_file_info(imagefileid),
    UNIQUE (file_id, version_number)
);
```

**3. æ™ºèƒ½æ¨è**

- ç›¸ä¼¼æ–‡æ¡£æ¨è
- åŸºäºå†…å®¹çš„æ¨è
- åŸºäºåˆ†ç±»çš„æ¨è

**å®ç°æ€è·¯**:
```python
# services/recommendation_service.py
class RecommendationService:
    def get_similar_documents(
        self, 
        file_id: str, 
        limit: int = 10
    ) -> List[OAFileInfo]:
        # ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
        file_info = self.get_file_info(file_id)
        embedding = self.get_embedding(file_info.content)
        
        # æŸ¥æ‰¾ç›¸ä¼¼å‘é‡
        similar = self.vector_search(embedding, limit)
        return similar
```

#### 11.2.2 ä¸­æœŸ (3-6 æœˆ)

**4. å…¨æ–‡æœç´¢**

- åŸºäº Elasticsearch çš„å…¨æ–‡æœç´¢
- æ”¯æŒä¸­æ–‡åˆ†è¯
- é«˜çº§æœç´¢è¯­æ³•

**å®ç°æ€è·¯**:
```python
# services/search_service.py
from elasticsearch import Elasticsearch

class SearchService:
    def __init__(self):
        self.es = Elasticsearch([settings.elasticsearch_url])
    
    def index_document(self, file_info: OAFileInfo, content: str):
        self.es.index(
            index='documents',
            id=file_info.imagefileid,
            body={
                'filename': file_info.imagefilename,
                'content': content,
                'category': file_info.business_category.value,
                'created_at': file_info.created_at
            }
        )
    
    def search(self, query: str, filters: Dict) -> List[Dict]:
        body = {
            'query': {
                'bool': {
                    'must': [
                        {'match': {'content': query}}
                    ],
                    'filter': [
                        {'term': {'category': filters.get('category')}}
                    ]
                }
            }
        }
        
        results = self.es.search(index='documents', body=body)
        return results['hits']['hits']
```

**5. å·¥ä½œæµå¼•æ“**

- è‡ªå®šä¹‰å®¡æ‰¹æµç¨‹
- å¤šçº§å®¡æ‰¹
- å¹¶è¡Œå®¡æ‰¹
- æ¡ä»¶åˆ†æ”¯

**å®ç°æ€è·¯**:
```python
# models/workflow.py
class Workflow(Base):
    __tablename__ = "workflows"
    
    id = Column(Integer, primary_key=True)
    name = Column(String(200))
    definition = Column(JSON)  # æµç¨‹å®šä¹‰
    status = Column(String(20))

class WorkflowInstance(Base):
    __tablename__ = "workflow_instances"
    
    id = Column(Integer, primary_key=True)
    workflow_id = Column(Integer, ForeignKey('workflows.id'))
    file_id = Column(String(100))
    current_step = Column(String(50))
    status = Column(String(20))

# services/workflow_engine.py
class WorkflowEngine:
    def start_workflow(self, workflow_id: int, file_id: str):
        ...
    
    def execute_step(self, instance_id: int):
        ...
    
    def approve_step(self, instance_id: int, approved: bool):
        ...
```

**6. æŠ¥è¡¨ç³»ç»Ÿ**

- å®šæœŸç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨
- è‡ªå®šä¹‰æŠ¥è¡¨æ¨¡æ¿
- å¯¼å‡ºå¤šç§æ ¼å¼ (PDF, Excel)

#### 11.2.3 é•¿æœŸ (6-12 æœˆ)

**7. å¾®æœåŠ¡æ‹†åˆ†**

- æ–‡æ¡£å¤„ç†æœåŠ¡
- AI åˆ†ææœåŠ¡
- çŸ¥è¯†åº“æœåŠ¡
- ç”¨æˆ·ç®¡ç†æœåŠ¡

**æ¶æ„æ¼”è¿›**:
```
Monolith â†’ Service-Oriented â†’ Microservices

å½“å‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OA Document System     â”‚
â”‚  (Monolithic)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Document  â”‚  â”‚    AI      â”‚  â”‚  Knowledge â”‚
â”‚  Service   â”‚  â”‚  Service   â”‚  â”‚  Base      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   API Gateway   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**8. æœºå™¨å­¦ä¹ ä¼˜åŒ–**

- æ–‡æ¡£åˆ†ç±»æ¨¡å‹è®­ç»ƒ
- è´¨é‡è¯„åˆ†æ¨¡å‹
- æ¨èç®—æ³•ä¼˜åŒ–

**9. å¤šç§Ÿæˆ·æ”¯æŒ**

- ç§Ÿæˆ·éš”ç¦»
- æ•°æ®éš”ç¦»
- èµ„æºé…é¢

### 11.3 æ€§èƒ½ä¼˜åŒ–

#### 11.3.1 æ•°æ®åº“ä¼˜åŒ–

**1. æŸ¥è¯¢ä¼˜åŒ–**

```python
# âŒ ä½æ•ˆæŸ¥è¯¢
files = db.query(OAFileInfo).all()
for file in files:
    logs = db.query(ProcessingLog).filter_by(file_id=file.imagefileid).all()

# âœ… ä¼˜åŒ–å
from sqlalchemy.orm import joinedload

files = db.query(OAFileInfo).options(
    joinedload(OAFileInfo.processing_logs)
).all()
```

**2. ç´¢å¼•ä¼˜åŒ–**

```sql
-- æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_file_status_category 
ON oa_file_info(processing_status, business_category);

-- æ·»åŠ éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_pending_files 
ON oa_file_info(created_at) 
WHERE processing_status = 'PENDING';
```

**3. åˆ†åŒºè¡¨**

```sql
-- æŒ‰æ—¶é—´åˆ†åŒº
CREATE TABLE oa_file_info_2024_01 PARTITION OF oa_file_info
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE oa_file_info_2024_02 PARTITION OF oa_file_info
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

#### 11.3.2 ç¼“å­˜ç­–ç•¥

**1. å¤šçº§ç¼“å­˜**

```
L1: åº”ç”¨å†…å­˜ç¼“å­˜ (LRU)
    â†“
L2: Redis ç¼“å­˜
    â†“
L3: æ•°æ®åº“
```

**2. ç¼“å­˜é¢„çƒ­**

```python
# utils/cache_warmup.py
def warmup_cache():
    # é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
    statistics = get_statistics()
    redis_client.setex('stats:overview', 3600, json.dumps(statistics))
    
    # é¢„åŠ è½½é…ç½®æ•°æ®
    knowledge_bases = get_all_knowledge_bases()
    for kb in knowledge_bases:
        redis_client.setex(
            f'kb:{kb.id}',
            7200,
            json.dumps(kb.to_dict())
        )
```

#### 11.3.3 å¼‚æ­¥ä¼˜åŒ–

**1. ä½¿ç”¨å¼‚æ­¥æ•°æ®åº“é©±åŠ¨**

```python
# database.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession

async_engine = create_async_engine(
    settings.database_url.replace('postgresql://', 'postgresql+asyncpg://'),
    echo=True
)

async def get_async_db():
    async with AsyncSession(async_engine) as session:
        yield session

# ä½¿ç”¨ç¤ºä¾‹
@router.get("/files/")
async def get_files(db: AsyncSession = Depends(get_async_db)):
    result = await db.execute(
        select(OAFileInfo).limit(20)
    )
    files = result.scalars().all()
    return files
```

**2. å¹¶å‘å¤„ç†**

```python
import asyncio

async def process_multiple_files(file_ids: List[str]):
    tasks = [process_file_async(file_id) for file_id in file_ids]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results
```

### 11.4 è¿ç»´æ”¹è¿›

#### 11.4.1 ç›‘æ§å‘Šè­¦

**1. Prometheus + Grafana**

```python
# utils/metrics.py
from prometheus_client import Counter, Histogram, Gauge

# å®šä¹‰æŒ‡æ ‡
documents_processed = Counter(
    'documents_processed_total',
    'Total documents processed',
    ['status', 'category']
)

processing_duration = Histogram(
    'document_processing_duration_seconds',
    'Time spent processing document',
    ['step']
)

queue_size = Gauge(
    'celery_queue_size',
    'Number of tasks in queue',
    ['queue_name']
)

# ä½¿ç”¨ç¤ºä¾‹
@track_metrics
def process_document(file_id: str):
    with processing_duration.labels(step='download').time():
        file_data = s3_service.download_file(...)
    
    # å¤„ç†å®Œæˆå
    documents_processed.labels(
        status='success',
        category=file_info.business_category.value
    ).inc()
```

**2. æ—¥å¿—èšåˆ**

- ELK Stack (Elasticsearch + Logstash + Kibana)
- é›†ä¸­å¼æ—¥å¿—ç®¡ç†
- æ—¥å¿—åˆ†æå’Œå‘Šè­¦

**3. APM (Application Performance Monitoring)**

```python
# ä½¿ç”¨ Sentry
import sentry_sdk

sentry_sdk.init(
    dsn=settings.sentry_dsn,
    traces_sample_rate=1.0,
    environment=settings.environment
)
```

#### 11.4.2 CI/CD ä¼˜åŒ–

**1. GitHub Actions å·¥ä½œæµ**

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install uv
          uv sync
      
      - name: Run tests
        run: |
          pytest --cov=. --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Run linting
        run: |
          pip install ruff
          ruff check .
      
      - name: Type checking
        run: |
          pip install mypy
          mypy .

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v2
      
      - name: Build Docker image
        run: docker build -t oatodify:${{ github.sha }} .
      
      - name: Push to registry
        run: docker push oatodify:${{ github.sha }}
```

**2. è‡ªåŠ¨åŒ–éƒ¨ç½²**

```bash
# scripts/deploy.sh
#!/bin/bash

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ„å»ºé•œåƒ
docker-compose build

# è¿è¡Œæ•°æ®åº“è¿ç§»
docker-compose run --rm api python run_migration.py

# é‡å¯æœåŠ¡
docker-compose up -d --no-deps api worker

# å¥åº·æ£€æŸ¥
curl -f http://localhost:8000/health || exit 1

echo "éƒ¨ç½²æˆåŠŸ!"
```

#### 11.4.3 å¤‡ä»½ç­–ç•¥

**1. æ•°æ®åº“å¤‡ä»½**

```bash
# scripts/backup_database.sh
#!/bin/bash

BACKUP_DIR="/backups/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/oa_docs_$DATE.sql.gz"

# æ‰§è¡Œå¤‡ä»½
pg_dump -h localhost -U postgres oa_docs | gzip > $BACKUP_FILE

# ä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

# ä¸Šä¼ åˆ° S3
aws s3 cp $BACKUP_FILE s3://backups/database/
```

**2. å®šæœŸå¤‡ä»½ä»»åŠ¡**

```python
# tasks/backup_tasks.py
@app.task
def daily_backup():
    # æ•°æ®åº“å¤‡ä»½
    subprocess.run(['bash', 'scripts/backup_database.sh'])
    
    # æ—¥å¿—å¤‡ä»½
    subprocess.run(['bash', 'scripts/backup_logs.sh'])
    
    logger.info("å¤‡ä»½å®Œæˆ")

# é…ç½® Celery Beat
app.conf.beat_schedule = {
    'daily-backup': {
        'task': 'tasks.backup_tasks.daily_backup',
        'schedule': crontab(hour=2, minute=0),  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹
    },
}
```

---

## 12. æŠ€æœ¯å€ºåŠ¡

### 12.1 å·²è¯†åˆ«çš„æŠ€æœ¯å€ºåŠ¡

#### 12.1.1 é«˜ä¼˜å…ˆçº§

**1. ç¼ºå°‘å•å…ƒæµ‹è¯•**

**é—®é¢˜**: 
- æµ‹è¯•è¦†ç›–ç‡å‡ ä¹ä¸º 0%
- éš¾ä»¥ä¿è¯ä»£ç è´¨é‡
- é‡æ„é£é™©é«˜

**å½±å“**: é«˜
**å·¥ä½œé‡**: ä¸­ (2-3 å‘¨)

**è§£å†³æ–¹æ¡ˆ**:
```python
# ç›®æ ‡: è¾¾åˆ° 80% æµ‹è¯•è¦†ç›–ç‡
# 1. ä¸ºæ ¸å¿ƒæœåŠ¡æ·»åŠ å•å…ƒæµ‹è¯•
# 2. ä¸º API ç«¯ç‚¹æ·»åŠ é›†æˆæµ‹è¯•
# 3. ä¸ºå…³é”®æµç¨‹æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•
```

**2. DOC æ ¼å¼ä¸æ”¯æŒ**

**é—®é¢˜**:
```python
def convert_doc_to_docx(self, doc_content: bytes, original_filename: str) -> bytes:
    # ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šæŠ›å‡ºå¼‚å¸¸
    raise NotImplementedError(
        "DOCæ ¼å¼æ–‡ä»¶éœ€è¦ä¸“é—¨çš„è½¬æ¢å·¥å…·"
    )
```

**å½±å“**: ä¸­
**å·¥ä½œé‡**: ä½ (1 å‘¨)

**è§£å†³æ–¹æ¡ˆ**:
- é›†æˆ LibreOffice æ— å¤´æ¨¡å¼
- æˆ–ä½¿ç”¨ unoconv
- æˆ–è°ƒç”¨åœ¨çº¿è½¬æ¢æœåŠ¡

**3. æ–‡ä»¶ç­›é€‰é€»è¾‘è¢«æ³¨é‡Š**

**é—®é¢˜**:
```python
# æ­¥éª¤0: æ–‡ä»¶ç­›é€‰æ£€æŸ¥
# logger.info(f"å¼€å§‹æ–‡ä»¶ç­›é€‰æ£€æŸ¥: {file_id}")
# filter_result = file_filter.should_process_file(file_info)
# ... (å¤§æ®µè¢«æ³¨é‡Šçš„ä»£ç )
```

**å½±å“**: ä¸­
**å·¥ä½œé‡**: ä½ (1 å‘¨)

**è§£å†³æ–¹æ¡ˆ**:
- è¯„ä¼°ç­›é€‰é€»è¾‘çš„å¿…è¦æ€§
- å¦‚æœéœ€è¦ï¼Œé‡æ–°å¯ç”¨å¹¶æµ‹è¯•
- å¦‚æœä¸éœ€è¦ï¼Œå½»åº•åˆ é™¤æ³¨é‡Šä»£ç 

#### 12.1.2 ä¸­ä¼˜å…ˆçº§

**4. å…¨å±€æœåŠ¡å®ä¾‹**

**é—®é¢˜**:
```python
# æ¨¡å—çº§å…¨å±€å®ä¾‹
s3_service = S3Service()
ai_analyzer = AIAnalyzer()
dify_service = DifyService()
```

**å½±å“**: ä¸­
**å·¥ä½œé‡**: ä¸­ (1-2 å‘¨)

**è§£å†³æ–¹æ¡ˆ**:
- å®ç°ä¾èµ–æ³¨å…¥
- ä½¿ç”¨å·¥å‚æ¨¡å¼
- ä¾¿äºæµ‹è¯•å’Œæ›¿æ¢

**5. å¼‚å¸¸å¤„ç†ç²—ç²’åº¦**

**é—®é¢˜**:
```python
try:
    # å¤§æ®µä»£ç 
    ...
except Exception as e:  # æ•è·èŒƒå›´è¿‡å¤§
    logger.error(f"é”™è¯¯: {e}")
```

**å½±å“**: ä½
**å·¥ä½œé‡**: ä¸­ (1-2 å‘¨)

**è§£å†³æ–¹æ¡ˆ**:
- æ•è·å…·ä½“å¼‚å¸¸ç±»å‹
- ç»†åŒ–å¼‚å¸¸å¤„ç†é€»è¾‘
- æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸ç±»

**6. é…ç½®ç¡¬ç¼–ç **

**é—®é¢˜**:
```python
content_preview = content[:2000]  # é­”æ³•æ•°å­—
max_retries = 3
retry_delay = 300
```

**å½±å“**: ä½
**å·¥ä½œé‡**: ä½ (å‡ å¤©)

**è§£å†³æ–¹æ¡ˆ**:
- æå–åˆ°é…ç½®æ–‡ä»¶æˆ–å¸¸é‡ç±»
- ä½¿ç”¨ç¯å¢ƒå˜é‡
- é›†ä¸­ç®¡ç†é…ç½®

#### 12.1.3 ä½ä¼˜å…ˆçº§

**7. æ—¥å¿—è®°å½•ä¸ç»Ÿä¸€**

**é—®é¢˜**:
- éƒ¨åˆ†ä½¿ç”¨ logger
- éƒ¨åˆ†ä½¿ç”¨ print
- æ ¼å¼ä¸ç»Ÿä¸€

**å½±å“**: ä½
**å·¥ä½œé‡**: ä½ (å‡ å¤©)

**8. æ•°æ®åº“ N+1 æŸ¥è¯¢**

**é—®é¢˜**:
- éƒ¨åˆ†æŸ¥è¯¢å­˜åœ¨ N+1 é—®é¢˜
- å½±å“æ€§èƒ½

**å½±å“**: ä½ (å½“å‰æ•°æ®é‡å°)
**å·¥ä½œé‡**: ä½ (å‡ å¤©)

**9. ç¼ºå°‘ API è®¤è¯**

**é—®é¢˜**:
- API æ— è®¤è¯æœºåˆ¶
- å®‰å…¨é£é™©

**å½±å“**: ä¸­ (å–å†³äºéƒ¨ç½²ç¯å¢ƒ)
**å·¥ä½œé‡**: ä¸­ (1 å‘¨)

### 12.2 æŠ€æœ¯å€ºåŠ¡ä¼˜å…ˆçº§çŸ©é˜µ

```
å½±å“ â†‘
 é«˜ â”‚  1. å•å…ƒæµ‹è¯•                    
    â”‚  
 ä¸­ â”‚  2. DOCæ ¼å¼      4. å…¨å±€å®ä¾‹    9. APIè®¤è¯
    â”‚  3. ç­›é€‰é€»è¾‘    5. å¼‚å¸¸å¤„ç†
    â”‚  
 ä½ â”‚  6. ç¡¬ç¼–ç        7. æ—¥å¿—        8. N+1æŸ¥è¯¢
    â”‚  
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
       ä½            ä¸­            é«˜      å·¥ä½œé‡
```

### 12.3 å¿è¿˜è®¡åˆ’

#### Sprint 1 (2 å‘¨)
- âœ… DOC æ ¼å¼æ”¯æŒ
- âœ… æ–‡ä»¶ç­›é€‰é€»è¾‘æ¸…ç†
- âœ… é…ç½®å¸¸é‡åŒ–

#### Sprint 2 (2 å‘¨)
- âœ… æ ¸å¿ƒæœåŠ¡å•å…ƒæµ‹è¯• (50% è¦†ç›–ç‡)
- âœ… API è®¤è¯å®ç°

#### Sprint 3 (2 å‘¨)
- âœ… å¼‚å¸¸å¤„ç†ä¼˜åŒ–
- âœ… æ—¥å¿—è®°å½•ç»Ÿä¸€
- âœ… ä¾èµ–æ³¨å…¥é‡æ„

#### Sprint 4 (2 å‘¨)
- âœ… å®Œå–„æµ‹è¯•è¦†ç›–ç‡ (80%)
- âœ… æ€§èƒ½ä¼˜åŒ– (N+1 æŸ¥è¯¢)
- âœ… ä»£ç å®¡æŸ¥å’Œæ¸…ç†

---

## 13. éƒ¨ç½²æ–¹æ¡ˆ

### 13.1 Docker Compose éƒ¨ç½² (æ¨è)

#### 13.1.1 æœåŠ¡ç»„ä»¶

```yaml
services:
  # API æœåŠ¡
  api:
    image: oatodify:latest
    ports: ["8000:8000"]
    command: ["fastapi"]
  
  # Web UI
  frontend:
    image: oatodify:latest
    ports: ["8501:8501"]
    command: ["streamlit"]
  
  # Worker æœåŠ¡ (å¯æ‰©å±•)
  worker:
    image: oatodify:latest
    command: ["celery-worker"]
    deploy:
      replicas: 2
  
  # å®šæ—¶ä»»åŠ¡
  beat:
    image: oatodify:latest
    command: ["celery-beat"]
  
  # ç›‘æ§
  flower:
    image: oatodify:latest
    ports: ["5555:5555"]
    command: ["celery-flower"]
  
  # æ•°æ®åº“
  postgres:
    image: postgres:15
    ports: ["5432:5432"]
  
  # ç¼“å­˜
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
```

#### 13.1.2 éƒ¨ç½²æ­¥éª¤

```bash
# 1. å…‹éš†ä»£ç 
git clone <repository-url>
cd oatodify

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # ç¼–è¾‘é…ç½®

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. åˆå§‹åŒ–æ•°æ®åº“
docker-compose exec api python run_migration.py

# 5. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# 6. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
```

#### 13.1.3 å¥åº·æ£€æŸ¥

```bash
# API å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# Web UI è®¿é—®
open http://localhost:8501

# Flower ç›‘æ§
open http://localhost:5555
```

### 13.2 Kubernetes éƒ¨ç½² (ç”Ÿäº§ç¯å¢ƒ)

#### 13.2.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ingress                             â”‚
â”‚              (Nginx Ingress Controller)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Service    â”‚ â”‚  Frontend   â”‚ â”‚  Flower     â”‚
â”‚  (ClusterIP)    â”‚ â”‚  (ClusterIP)â”‚ â”‚  (ClusterIP)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ API Pod â”‚     â”‚  UI Podâ”‚     â”‚Flower  â”‚
    â”‚ (3 å‰¯æœ¬)â”‚     â”‚ (2 å‰¯æœ¬)â”‚     â”‚ (1 å‰¯æœ¬)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Worker Deployment                         â”‚
â”‚              (5 å‰¯æœ¬ï¼ŒHPA è‡ªåŠ¨æ‰©å±•)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL â”‚  â”‚   Redis    â”‚  â”‚  S3/MinIO  â”‚
â”‚ StatefulSetâ”‚  â”‚ StatefulSetâ”‚  â”‚  External  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.2.2 Kubernetes é…ç½®

**Deployment - API**:
```yaml
# k8s/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oa-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: oa-api
  template:
    metadata:
      labels:
        app: oa-api
    spec:
      containers:
      - name: api
        image: oatodify:latest
        command: ["fastapi"]
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: oa-secrets
              key: database-url
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
```

**Service**:
```yaml
# k8s/api-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: oa-api
spec:
  selector:
    app: oa-api
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: ClusterIP
```

**HPA (Horizontal Pod Autoscaler)**:
```yaml
# k8s/worker-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: oa-worker
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: oa-worker
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**Ingress**:
```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: oa-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - oa.example.com
    secretName: oa-tls
  rules:
  - host: oa.example.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: oa-api
            port:
              number: 8000
      - path: /
        pathType: Prefix
        backend:
          service:
            name: oa-frontend
            port:
              number: 8501
```

#### 13.2.3 éƒ¨ç½²å‘½ä»¤

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace oa-system

# 2. åˆ›å»º Secrets
kubectl create secret generic oa-secrets \
  --from-literal=database-url='postgresql://...' \
  --from-literal=redis-url='redis://...' \
  --from-literal=openai-api-key='sk-...' \
  -n oa-system

# 3. éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/ -n oa-system

# 4. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n oa-system
kubectl get services -n oa-system

# 5. æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/oa-api -n oa-system

# 6. è®¿é—®åº”ç”¨
kubectl port-forward service/oa-api 8000:8000 -n oa-system
```

### 13.3 äº‘æœåŠ¡éƒ¨ç½²

#### 13.3.1 AWS ECS éƒ¨ç½²

**æ¶æ„**:
```
Application Load Balancer
    â†“
ECS Service (Fargate)
    â”œâ”€â”€ API Task (3 instances)
    â”œâ”€â”€ Frontend Task (2 instances)
    â””â”€â”€ Worker Task (Auto Scaling)
    â†“
RDS PostgreSQL + ElastiCache Redis
```

**Task Definition**:
```json
{
  "family": "oa-api",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "containerDefinitions": [
    {
      "name": "api",
      "image": "oatodify:latest",
      "command": ["fastapi"],
      "portMappings": [
        {
          "containerPort": 8000,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "DATABASE_URL",
          "value": "postgresql://..."
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/oa-api",
          "awslogs-region": "us-east-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
```

#### 13.3.2 Azure Container Instances

```bash
# åˆ›å»ºèµ„æºç»„
az group create --name oa-rg --location eastus

# åˆ›å»ºå®¹å™¨å®ä¾‹
az container create \
  --resource-group oa-rg \
  --name oa-api \
  --image oatodify:latest \
  --command-line "fastapi" \
  --cpu 1 \
  --memory 2 \
  --ports 8000 \
  --environment-variables \
    DATABASE_URL='postgresql://...' \
    REDIS_URL='redis://...'
```

### 13.4 ç›‘æ§å’Œæ—¥å¿—

#### 13.4.1 Prometheus + Grafana

**Prometheus é…ç½®**:
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'oa-api'
    static_configs:
      - targets: ['oa-api:8000']
  
  - job_name: 'celery'
    static_configs:
      - targets: ['oa-worker:9090']
```

**Grafana Dashboard**:
- æ–‡æ¡£å¤„ç†ååé‡
- API è¯·æ±‚å»¶è¿Ÿ
- Worker é˜Ÿåˆ—é•¿åº¦
- é”™è¯¯ç‡
- ç³»ç»Ÿèµ„æºä½¿ç”¨

#### 13.4.2 ELK Stack

**Filebeat é…ç½®**:
```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/oa/*.log
  fields:
    app: oatodify
    env: production

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "oatodify-%{+yyyy.MM.dd}"
```

**Logstash Pipeline**:
```
input {
  beats {
    port => 5044
  }
}

filter {
  grok {
    match => {
      "message" => "%{TIMESTAMP_ISO8601:timestamp} - %{LOGLEVEL:level} - %{GREEDYDATA:msg}"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "oatodify-%{+yyyy.MM.dd}"
  }
}
```

---

## ç»“è®º

### é¡¹ç›®æ•´ä½“è¯„ä»·

**ä¼˜ç‚¹** â­â­â­â­â˜†:
- âœ… æ¶æ„è®¾è®¡æ¸…æ™°ï¼Œåˆ†å±‚åˆç†
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œè¦†ç›–æ–‡æ¡£å¤„ç†å…¨ç”Ÿå‘½å‘¨æœŸ
- âœ… æ”¯æŒå¤šçŸ¥è¯†åº“å’Œä¸šåŠ¡åˆ†ç±»è·¯ç”±
- âœ… æ–‡æ¡£è´¨é‡é«˜ï¼Œå°¤å…¶æ˜¯ README
- âœ… ä½¿ç”¨ç°ä»£æŠ€æœ¯æ ˆ (FastAPI, Streamlit, Celery)
- âœ… Docker å®¹å™¨åŒ–ï¼Œä¾¿äºéƒ¨ç½²

**éœ€è¦æ”¹è¿›** âš ï¸:
- âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âš ï¸ éƒ¨åˆ†ä»£ç æœ‰æŠ€æœ¯å€ºåŠ¡ (æ³¨é‡Šä»£ç ã€ç¡¬ç¼–ç )
- âš ï¸ ç¼ºå°‘ API è®¤è¯æœºåˆ¶
- âš ï¸ ç›‘æ§å’Œå‘Šè­¦ä¸å®Œå–„
- âš ï¸ DOC æ ¼å¼ä¸æ”¯æŒ

### æ¨èè¡ŒåŠ¨è®¡åˆ’

**ç¬¬ä¸€é˜¶æ®µ** (1-2 æœˆ):
1. è¡¥å……å•å…ƒæµ‹è¯•ï¼Œè¾¾åˆ° 50% è¦†ç›–ç‡
2. å®ç° API è®¤è¯
3. æ¸…ç†æŠ€æœ¯å€ºåŠ¡ (æ³¨é‡Šä»£ç ã€ç¡¬ç¼–ç )
4. æ·»åŠ  DOC æ ¼å¼æ”¯æŒ

**ç¬¬äºŒé˜¶æ®µ** (3-4 æœˆ):
5. å®Œå–„æµ‹è¯•è¦†ç›–ç‡ï¼Œè¾¾åˆ° 80%
6. å®ç°ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
7. ä¼˜åŒ–æ€§èƒ½ (æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜)
8. å¢å¼ºåŠŸèƒ½ (å…¨æ–‡æœç´¢ã€ç‰ˆæœ¬ç®¡ç†)

**ç¬¬ä¸‰é˜¶æ®µ** (5-6 æœˆ):
9. å¾®æœåŠ¡æ‹†åˆ† (å¦‚æœéœ€è¦)
10. æœºå™¨å­¦ä¹ ä¼˜åŒ–
11. å¤šç§Ÿæˆ·æ”¯æŒ
12. å®Œå–„æ–‡æ¡£å’ŒåŸ¹è®­ææ–™

### æ€»ç»“

Oatodify æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½ã€åŠŸèƒ½å®Œæ•´çš„ OA æ–‡æ¡£å¤„ç†ç³»ç»Ÿã€‚æ¶æ„æ¸…æ™°ï¼Œä½¿ç”¨ç°ä»£æŠ€æœ¯æ ˆï¼Œæ–‡æ¡£è´¨é‡é«˜ã€‚ä¸»è¦éœ€è¦æ”¹è¿›çš„æ˜¯æµ‹è¯•è¦†ç›–ç‡ã€ä»£ç è´¨é‡å’Œç›‘æ§ä½“ç³»ã€‚é€šè¿‡ç³»ç»ŸåŒ–çš„æ”¹è¿›è®¡åˆ’ï¼Œå¯ä»¥å°†å…¶æ‰“é€ æˆä¸€ä¸ªä¼ä¸šçº§çš„ç”Ÿäº§å°±ç»ªç³»ç»Ÿã€‚

---

**æŠ¥å‘Šç”Ÿæˆ**: 2025-10-17  
**åˆ†æäºº**: AI ä»£ç åˆ†æåŠ©æ‰‹  
**ç‰ˆæœ¬**: 1.0.0
